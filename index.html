<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Attendance Management</title>

  <!-- PWA & Meta -->
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#2196F3" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="application-name" content="Attendance Mgmt" />

  <!-- Font Awesome -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    integrity="sha512-o8C6XNsy1QM7qelJ9lKt1QLdH6Ff8T4y9f3vbYTNXmaJQ0D5MocpfYhAwI0VVHS19iQ+N9IjcWcJuTZxAut+Dw=="
    crossorigin="anonymous"
    referrerpolicy="no-referrer"
  />

  <!-- idb-keyval (for IndexedDB) -->
  <script src="https://cdn.jsdelivr.net/npm/idb-keyval@3/dist/idb-keyval-iife.min.js"></script>

  <!-- jsPDF + AutoTable (for PDF exports) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

  <!-- Chart.js (for analytics charts) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Main CSS (you can customize this) -->
  <link rel="stylesheet" href="style.css" />

  <style>
    /* Basic mobile-friendly layout & simple styling */
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background-color: #f5f7fa;
      color: #333;
      line-height: 1.5;
    }

    .btn {
      background-color: #2196f3;
      border: none;
      color: white;
      padding: 0.6em 1.2em;
      margin: 0.3em;
      font-size: 1rem;
      border-radius: 8px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    .btn i {
      margin-right: 0.4em;
    }
    .btn:hover {
      background-color: #1976d2;
    }

    input, select {
      padding: 0.5em;
      margin: 0.3em 0;
      font-size: 1rem;
      border: 1px solid #ccc;
      border-radius: 6px;
      width: 100%;
      box-sizing: border-box;
    }

    h1, h2, h3 {
      margin: 1rem 0 0.5rem;
      font-weight: 600;
    }

    .app-header {
      background-color: #2196f3;
      color: white;
      padding: 1em;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .app-header h1 {
      font-size: 1.25rem;
      margin: 0;
    }
    .header-buttons .btn {
      background-color: transparent;
      color: white;
      font-size: 1.2rem;
      padding: 0.3em 0.6em;
    }
    .header-buttons .btn:hover {
      background-color: rgba(255,255,255,0.15);
    }

    section {
      padding: 1em;
      background-color: white;
      margin: 0.5em 1em;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .row-inline {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5em;
      align-items: center;
    }
    .row-inline input,
    .row-inline select {
      flex: 1;
      min-width: 120px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 0.5em;
    }
    table th,
    table td {
      border: 1px solid #ddd;
      padding: 0.6em;
      text-align: left;
      font-size: 0.9rem;
    }
    table th {
      background-color: #f0f0f0;
      font-weight: 600;
    }
    .table-wrapper {
      overflow-x: auto;
    }
    .table-actions {
      margin-top: 0.5em;
      display: flex;
      flex-wrap: wrap;
      gap: 0.5em;
    }

    .hidden {
      display: none !important;
    }
    .no-print {
      /* You can add rules to hide when printing, if needed */
    }
    .scroll-row {
      display: flex;
      overflow-x: auto;
      gap: 1em;
      padding: 0.5em 0;
    }
    .counter-card {
      background-color: #fafafa;
      border-radius: 8px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
      flex: 0 0 120px;
      padding: 1em;
      text-align: center;
      margin-right: 0.5em;
      min-width: 120px;
    }
    .card-title {
      font-size: 0.9rem;
      margin: 0;
      color: #555;
    }
    .card-number {
      font-size: 1.5rem;
      font-weight: 600;
      margin-top: 0.3em;
    }

    .attendance-row {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      border-bottom: 1px solid #e0e0e0;
      padding: 0.5em 0;
    }
    .attendance-header {
      flex: 1 1 40%;
      font-weight: 500;
    }
    .attendance-buttons {
      flex: 1 1 60%;
      display: flex;
      gap: 0.3em;
      flex-wrap: wrap;
    }
    .att-btn {
      flex: 1 1 50px;
      padding: 0.5em;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 0.9rem;
      background-color: #fafafa;
      cursor: pointer;
    }
    .att-btn.selected {
      color: white;
    }

    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1em;
      z-index: 1000;
    }
    .modal.hidden {
      display: none;
    }
    .modal-content {
      background-color: white;
      border-radius: 8px;
      padding: 1em;
      width: 100%;
      max-width: 400px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      position: relative;
    }
    .modal-close {
      position: absolute;
      top: 0.5em;
      right: 0.5em;
      font-size: 1.2rem;
      cursor: pointer;
      color: #777;
    }
    .modal-close:hover {
      color: #333;
    }
    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 0.5em;
      margin-top: 1em;
    }
  </style>
</head>
<body>

  <!-- AUTH SCREEN -->
  <div
    id="authScreen"
    style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; padding: 1em; background-color: #f5f7fa;"
  >
    <h2 style="margin-bottom: 1em;">Attendance Mgmt Login / Register</h2>
    <div style="margin-bottom: 1.5em; display: flex; gap: 1em;">
      <button id="showLogin" class="btn"><i class="fas fa-sign-in-alt"></i> Login</button>
      <button id="showRegister" class="btn"><i class="fas fa-user-plus"></i> Register</button>
    </div>

    <!-- LOGIN FORM -->
    <form
      id="loginForm"
      style="display: flex; flex-direction: column; gap: 0.5em; width: 100%; max-width: 320px;"
    >
      <input id="loginEmail" type="email" placeholder="Email" required />
      <input id="loginPassword" type="password" placeholder="Password" required />
      <button type="submit" class="btn" style="width: 100%;"><i class="fas fa-key"></i> Login</button>
    </form>

    <!-- REGISTER FORM -->
    <form
      id="registerForm"
      class="hidden"
      style="flex-direction: column; gap: 0.5em; width: 100%; max-width: 320px;"
    >
      <input id="regEmail" type="email" placeholder="Email" required />
      <input id="regPassword" type="password" placeholder="Password" required />
      <select id="regRole" required>
        <option disabled selected value="">-- Select Role --</option>
        <option value="admin">Admin</option>
        <option value="principal">Principal</option>
        <option value="teacher">Teacher</option>
      </select>
      <select id="regSchool" class="hidden">
        <option disabled selected value="">-- Select School --</option>
      </select>
      <select id="regClass" class="hidden">
        <option disabled selected value="">-- Select Class --</option>
        <option>Play Group</option>
        <option>Nursery</option>
        <option>KG</option>
        <option>Class One</option>
        <option>Class Two</option>
        <option>Class Three</option>
        <option>Class Four</option>
        <option>Class Five</option>
        <option>Class Six</option>
        <option>Class Seven</option>
        <option>Class Eight</option>
        <option>Class Nine</option>
        <option>Class Ten</option>
      </select>
      <select id="regSection" class="hidden">
        <option disabled selected value="">-- Select Section --</option>
        <option>A</option>
        <option>B</option>
        <option>C</option>
      </select>
      <button type="submit" class="btn" style="width: 100%;"><i class="fas fa-user-plus"></i> Register</button>
    </form>
  </div>

  <!-- MAIN APPLICATION (hidden until auth) -->
  <div id="mainApp" class="hidden">
    <!-- HEADER -->
    <header class="app-header">
      <h1><i class="fas fa-school"></i> Attendance Management</h1>
      <div class="header-buttons">
        <button id="logoutBtn" class="btn"><i class="fas fa-sign-out-alt"></i></button>
      </div>
    </header>

    <main style="padding-bottom: 2em;">
      <!-- 1. SETUP SECTION -->
      <section id="teacher-setup">
        <h2><i class="fas fa-cog"></i> Setup</h2>
        <div id="setupForm" class="row-inline">
          <input id="schoolInput" placeholder="New School Name" />
          <select id="schoolSelect">
            <option disabled selected value="">-- Select School --</option>
          </select>
          <select id="teacherClassSelect">
            <option disabled selected value="">-- Select Class --</option>
            <option>Play Group</option>
            <option>Nursery</option>
            <option>KG</option>
            <option>Class One</option>
            <option>Class Two</option>
            <option>Class Three</option>
            <option>Class Four</option>
            <option>Class Five</option>
            <option>Class Six</option>
            <option>Class Seven</option>
            <option>Class Eight</option>
            <option>Class Nine</option>
            <option>Class Ten</option>
          </select>
          <select id="teacherSectionSelect">
            <option disabled selected value="">-- Select Section --</option>
            <option>A</option>
            <option>B</option>
            <option>C</option>
          </select>
          <button id="saveSetup" class="btn"><i class="fas fa-save"></i> Save</button>
        </div>
        <div id="schoolList" style="margin-top: 1em;"></div>
        <div id="setupDisplay" class="hidden" style="margin-top: 1em;">
          <h3>
            <i class="fas fa-school no-print"></i>
            <span id="setupText"></span>
          </h3>
          <button id="editSetup" class="btn no-print"><i class="fas fa-edit"></i> Edit</button>
        </div>
      </section>

      <!-- 2. FINANCIAL SETTINGS -->
      <section id="financial-settings" class="hidden">
        <h2><i class="fas fa-wallet"></i> Fines & Eligibility</h2>
        <div id="financialForm" class="row-inline">
          <label>Fine/Absent (PKR):<input id="fineAbsent" type="number" /></label>
          <label>Fine/Late (PKR):<input id="fineLate" type="number" /></label>
          <label>Fine/Leave (PKR):<input id="fineLeave" type="number" /></label>
          <label>Fine/Half-Day (PKR):<input id="fineHalfDay" type="number" /></label>
          <label>Eligib. % (≥):<input id="eligibilityPct" type="number" min="0" max="100" /></label>
          <button id="saveSettings" class="btn"><i class="fas fa-save"></i> Save</button>
        </div>
      </section>

      <!-- 3. COUNTERS DASHBOARD -->
      <section id="animatedCounters" class="hidden">
        <div id="countersContainer" class="scroll-row"></div>
      </section>

      <!-- 4. STUDENT REGISTRATION -->
      <section id="student-registration" class="hidden">
        <h2><i class="fas fa-user-graduate"></i> Student Registration</h2>
        <div class="row-inline">
          <input id="studentName" placeholder="Name" />
          <input id="parentName" placeholder="Parent Name" />
          <input id="parentContact" placeholder="Contact (7–15 digits)" />
          <input id="parentOccupation" placeholder="Occupation" />
          <input id="parentAddress" placeholder="Address" />
          <button id="addStudent" class="btn"><i class="fas fa-plus-circle"></i> Add</button>
        </div>
        <div class="table-wrapper" style="margin-top: 1em;">
          <table id="studentsTable">
            <thead>
              <tr>
                <th><input type="checkbox" id="selectAllStudents" /></th>
                <th>#</th>
                <th>Name</th>
                <th>Adm#</th>
                <th>Parent</th>
                <th>Contact</th>
                <th>Occupation</th>
                <th>Address</th>
                <th>Fine (PKR)</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="studentsBody"></tbody>
          </table>
        </div>
        <div class="table-actions">
          <button id="editSelected" disabled class="btn"><i class="fas fa-edit"></i> Edit</button>
          <button id="doneEditing" class="btn hidden"><i class="fas fa-check"></i> Done</button>
          <button id="deleteSelected" disabled class="btn"><i class="fas fa-trash"></i> Delete</button>
          <button id="saveRegistration" class="btn"><i class="fas fa-save"></i> Save</button>
          <button id="editRegistration" class="btn hidden"><i class="fas fa-undo"></i> Restore</button>
          <button id="shareRegistration" class="btn hidden"><i class="fas fa-share-alt"></i> Share</button>
          <button id="downloadRegistrationPDF" class="btn hidden"><i class="fas fa-download"></i> Download</button>
        </div>
      </section>

      <!-- 5. MARK ATTENDANCE -->
      <section id="attendance-section" class="hidden">
        <h2><i class="fas fa-calendar-check"></i> Mark Attendance</h2>
        <div class="row-inline">
          <input type="date" id="dateInput" />
          <button id="loadAttendance" class="btn"><i class="fas fa-calendar-check"></i> Load</button>
        </div>
        <div id="attendanceBody" style="margin-top: 1em;"></div>
        <div id="attendanceSummary" class="hidden" style="margin-top: 1em;"></div>
        <div class="table-actions">
          <button id="saveAttendance" class="btn hidden"><i class="fas fa-save"></i> Save</button>
          <button id="resetAttendance" class="btn hidden"><i class="fas fa-undo"></i> Reset</button>
          <button id="downloadAttendancePDF" class="btn hidden"><i class="fas fa-download"></i> Download</button>
          <button id="shareAttendanceSummary" class="btn hidden"><i class="fas fa-share-alt"></i> Share</button>
        </div>
      </section>

      <!-- 6. ANALYTICS -->
      <section id="analytics-section" class="hidden">
        <h2>
          <i class="fas fa-chart-bar"></i> Analytics
          <button id="analyticsFilterBtn" class="btn"><i class="fas fa-filter"></i> Filter</button>
        </h2>
        <div class="row-inline" style="flex-wrap: wrap;">
          <select id="analyticsTarget">
            <option disabled selected value="">-- Report For --</option>
            <option value="class">Class</option>
            <option value="section">Section</option>
            <option value="student">Student</option>
          </select>
          <select id="analyticsSectionSelect" class="hidden">
            <option disabled selected value="">-- Section --</option>
            <option>A</option>
            <option>B</option>
            <option>C</option>
          </select>
          <select id="analyticsType" disabled>
            <option disabled selected value="">-- Period --</option>
            <option value="date">Date</option>
            <option value="month">Month</option>
            <option value="semester">Semester</option>
            <option value="year">Year</option>
          </select>
          <input type="date" id="analyticsDate" class="hidden" />
          <input type="month" id="analyticsMonth" class="hidden" />
          <input type="month" id="semesterStart" class="hidden" />
          <input type="month" id="semesterEnd" class="hidden" />
          <input type="number" id="yearStart" class="hidden" placeholder="Year" />
          <input type="text" id="analyticsSearch" class="hidden" placeholder="Adm# or Name" />
          <button id="loadAnalytics" class="btn"><i class="fas fa-chart-bar"></i> Load</button>
          <button id="resetAnalytics" class="btn hidden"><i class="fas fa-undo"></i> Change</button>
        </div>
        <div id="instructions" class="hidden" style="margin-top: 0.5em; font-style: italic;"></div>
        <div id="analyticsContainer" class="table-wrapper hidden" style="margin-top: 1em;">
          <table id="analyticsTable">
            <thead><tr></tr></thead>
            <tbody id="analyticsBody"></tbody>
          </table>
        </div>
        <div id="graphs" class="hidden" style="margin-top: 1em;">
          <canvas id="barChart" style="max-width: 100%; height: 200px;"></canvas>
          <canvas id="pieChart" style="max-width: 100%; height: 200px; margin-top: 1em;"></canvas>
        </div>
        <div class="table-actions hidden" id="analyticsActions" style="margin-top: 1em;">
          <button id="downloadAnalytics" class="btn"><i class="fas fa-download"></i> Download</button>
          <button id="shareAnalytics" class="btn"><i class="fas fa-share-alt"></i> Share</button>
        </div>
      </section>

      <!-- 7. ATTENDANCE REGISTER -->
      <section id="register-section" class="hidden">
        <h2><i class="fas fa-book-open"></i> Attendance Register</h2>
        <div class="row-inline">
          <input type="month" id="registerMonth" />
          <button id="loadRegister" class="btn"><i class="fas fa-calendar-alt"></i> Load</button>
        </div>
        <div id="registerTableWrapper" class="hidden table-wrapper" style="margin-top: 1em;">
          <table id="registerTable">
            <thead><tr id="registerHeader"></tr></thead>
            <tbody id="registerBody"></tbody>
          </table>
        </div>
        <div class="table-actions" style="margin-top: 0.5em;">
          <button id="changeRegister" class="btn hidden"><i class="fas fa-undo"></i> Reset</button>
          <button id="saveRegister" class="btn hidden"><i class="fas fa-save"></i> Save</button>
          <button id="downloadRegister" class="btn"><i class="fas fa-download"></i> Download</button>
          <button id="shareRegister" class="btn hidden"><i class="fas fa-share-alt"></i> Share</button>
        </div>
      </section>

      <!-- PAYMENT MODAL -->
      <div id="paymentModal" class="modal hidden">
        <div class="modal-content">
          <span id="paymentModalClose" class="modal-close">&times;</span>
          <h3><i class="fas fa-coins"></i> Payment for Adm# <span id="payAdm"></span></h3>
          <label>Amount (PKR): <input id="paymentAmount" type="number" /></label>
          <div class="modal-actions">
            <button id="savePayment" class="btn"><i class="fas fa-check"></i> Save</button>
            <button id="cancelPayment" class="btn"><i class="fas fa-times"></i> Cancel</button>
          </div>
        </div>
      </div>

      <!-- ANALYTICS FILTER MODAL -->
      <div id="analyticsFilterModal" class="modal hidden">
        <div class="modal-content">
          <span id="analyticsFilterClose" class="modal-close">&times;</span>
          <h3><i class="fas fa-filter"></i> Filter Reports</h3>
          <form id="analyticsFilterForm">
            <label><input type="checkbox" value="registered" checked /> Registered Students</label><br />
            <label><input type="checkbox" value="attendance" /> Attendance Records</label><br />
            <label><input type="checkbox" value="fine" /> Fine Incurred</label><br />
            <label><input type="checkbox" value="cleared" /> Cleared (No Dues)</label><br />
            <label><input type="checkbox" value="debarred" /> Debarred</label><br />
            <label><input type="checkbox" value="eligible" /> Eligible</label><br />
            <label><input type="checkbox" value="all" /> All Students</label>
            <fieldset style="margin-top: 1em;">
              <legend>Download Mode</legend>
              <label><input type="radio" name="downloadMode" value="combined" checked /> Combined PDF</label><br />
              <label><input type="radio" name="downloadMode" value="individual" /> Individual PDFs</label>
            </fieldset>
            <div class="modal-actions" style="margin-top: 1em;">
              <button type="button" id="applyAnalyticsFilter" class="btn"><i class="fas fa-check"></i> Apply Filter</button>
            </div>
          </form>
        </div>
      </div>

      <!-- 8. BACKUP & RESTORE -->
      <section id="backup-restore" class="hidden">
        <h2><i class="fas fa-database"></i> Backup & Restore</h2>
        <button id="chooseBackupFolder" class="btn"><i class="fas fa-folder-open"></i> Choose Backup Folder</button>
        <button id="restoreData" class="btn"><i class="fas fa-file-import"></i> Restore Data</button>
        <input type="file" id="restoreFile" accept=".json" class="hidden" />
        <button id="resetData" class="btn"><i class="fas fa-trash-alt"></i> Factory Reset</button>
      </section>
    </main>

    <!-- Include the main JavaScript (module) -->
    <script type="module" src="app.js"></script>
  </div>

  <!-- Service Worker Registration (optional if you have service-worker.js) -->
  <script>
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker
          .register("service-worker.js", { type: "module" })
          .then((reg) => console.log("Service Worker registered:", reg))
          .catch((err) => console.error("SW registration failed:", err));
      });
    }
  </script>
</body>
</html>
