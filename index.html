<!-- index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Attendance Management</title>

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

  <!-- idb-keyval -->
  <script src="https://cdn.jsdelivr.net/npm/idb-keyval@3/dist/idb-keyval-iife.min.js"></script>

  <!-- PWA & jsPDF & Chart.js, etc. -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

  <style>
    .hidden { display: none !important; }
    .card { border: 1px solid #ccc; padding: 1em; margin: 1em 0; border-radius: 4px; }
    .btn { margin: 0.5em 0; }
    .row-inline > * { margin-right: 0.5em; }
  </style>
</head>
<body>

  <!-- LOGIN & SIGNUP -->
  <section id="authContainer">
    <div id="loginSection" class="card">
      <h2>Login</h2>
      <form id="loginForm">
        <input id="loginUserId" name="userId" placeholder="User ID" required />
        <input id="loginKey"    name="key"    placeholder="Key" type="password" required />
        <button type="submit" class="btn">Login</button>
      </form>
    </div>

    <div id="signupSection" class="card">
      <h2>Sign Up</h2>
      <form id="signupForm">
        <input id="signupName"   name="name"   placeholder="Name" required />
        <select id="signupRole"  name="role"   required>
          <option disabled selected>-- Role --</option>
          <option>Admin</option>
          <option>Principal</option>
          <option>Teacher</option>
        </select>
        <input id="signupSchool" name="school" placeholder="School" required />
        <input id="signupUserId" name="userId" placeholder="User ID" required />
        <input id="signupKey"    name="key"    placeholder="Key" type="password" required />
        <div id="classSectionFields" class="hidden row-inline">
          <select id="signupClass" name="cls">
            <option disabled selected>-- Class --</option>
            <option>Play Group</option><option>Nursery</option><option>KG</option>
            <option>Class One</option><option>Class Two</option><!-- etc. -->
          </select>
          <select id="signupSection" name="sec">
            <option disabled selected>-- Section --</option>
            <option>A</option><option>B</option><option>C</option>
          </select>
        </div>
        <button type="submit" class="btn">Submit</button>
      </form>
    </div>

    <!-- SETUP (after login) -->
    <section id="teacher-setup" class="card hidden">
      <h2>Setup</h2>
      <div class="row-inline">
        <input id="schoolInput" placeholder="New School Name" class="hidden" />
        <select id="schoolSelect">
          <option disabled selected>-- Select School --</option>
        </select>
        <select id="classSelect">
          <option disabled selected>-- Select Class --</option>
        </select>
        <select id="sectionSelect" class="hidden">
          <option disabled selected>-- Select Section --</option>
          <option>A</option><option>B</option><option>C</option>
        </select>
        <button id="saveSetup" class="btn">Save</button>
      </div>
    </section>
  </section>

  <!-- MAIN APP (hidden until setup) -->
  <div id="mainApp" class="hidden">
    <header id="appHeader" class="card">
      <h1>Attendance Management</h1>
      <!-- backup buttons, etc. -->
    </header>
    <!-- ... your existing sections (financial-settings, student-registration, attendance-section, analytics-section, register-section) ... -->
  </div>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import {
      getDatabase,
      ref as dbRef,
      get,
      push
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";
    const { get: idbGet, set: idbSet } = window.idbKeyval;

    // —— Your full config including databaseURL —— 
    const firebaseConfig = {
      apiKey: "AIzaSyBsx…EpICEzA",
      authDomain: "attandace-management.firebaseapp.com",
      databaseURL: "https://attandace-management-default-rtdb.firebaseio.com",
      projectId: "attandace-management",
      storageBucket: "attandace-management.appspot.com",
      messagingSenderId: "222685278846",
      appId: "1:222685278846:web:aa3e37a42b76befb6f5e2f",
      measurementId: "G-V2MY85R73B"
    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const usersRef   = dbRef(db, 'users');
    const pendingRef = dbRef(db, 'pendingUsers');
    const schoolsRef = dbRef(db, 'appData/schools');

    // Elements
    const loginForm   = document.getElementById('loginForm');
    const signupForm  = document.getElementById('signupForm');
    const signupRole  = document.getElementById('signupRole');
    const classFields = document.getElementById('classSectionFields');

    // Show/hide class-section for Teachers
    signupRole.addEventListener('change', () =>
      classFields.classList.toggle('hidden', signupRole.value !== 'Teacher')
    );

    // Sign Up
    signupForm.addEventListener('submit', async e => {
      e.preventDefault();
      const name   = signupForm.name.value.trim();
      const role   = signupRole.value;
      const school = signupForm.school.value.trim();
      const uid    = signupForm.userId.value.trim();
      const key    = signupForm.key.value.trim();
      const cls    = role==='Teacher' ? signupForm.cls.value : null;
      const sec    = role==='Teacher' ? signupForm.sec.value : null;
      if (!name||!role||!school||!uid||!key || (role==='Teacher' && (!cls||!sec))) {
        return alert('تمام فیلڈز بھر دیں۔');
      }
      await push(pendingRef, { name, role, school, userId: uid, key, cls, sec, active: false });
      alert('درخواست بھیج دی گئی۔ Admin کی منظوری کا انتظار کریں۔');
      signupForm.reset();
      classFields.classList.add('hidden');
    });

    // Login & showSetup
    loginForm.addEventListener('submit', async e => {
      e.preventDefault();
      const userId = loginForm.userId.value.trim();
      const key    = loginForm.key.value.trim();
      if (!userId||!key) return alert('User ID اور Key دونوں داخل کریں۔');
      const snap = await get(dbRef(db, `users/${userId}`));
      if (!snap.exists() || snap.val().key!==key || !snap.val().active) {
        return alert('Invalid credentials یا ابھی approve نہیں ہوئے۔');
      }
      const u = snap.val();
      const sess = { userId, role: u.role, school: u.school, cls: u.cls, sec: u.sec };
      await idbSet('session', sess);
      showSetup(sess);
    });

    // Auto-login
    (async()=>{
      const sess = await idbGet('session');
      if (sess) showSetup(sess);
    })();

    // showSetup implementation
    async function showSetup(sess) {
      document.getElementById('loginSection').classList.add('hidden');
      document.getElementById('signupSection').classList.add('hidden');
      const setup = document.getElementById('teacher-setup');
      setup.classList.remove('hidden');

      // populate schools
      const snap = await get(schoolsRef);
      const schools = snap.exists() ? Object.values(snap.val()) : [];
      const ss = document.getElementById('schoolSelect');
      ss.innerHTML = '<option disabled selected>-- Select School --</option>';
      schools.forEach(s=> ss.append(new Option(s,s)));

      // role-specific
      const inpNewSchool = document.getElementById('schoolInput');
      const selClass     = document.getElementById('classSelect');
      const selSection   = document.getElementById('sectionSelect');

      if (sess.role==='Admin') {
        inpNewSchool.classList.remove('hidden');
        selClass.classList.remove('hidden');
        selSection.classList.remove('hidden');
      } else if (sess.role==='Principal') {
        inpNewSchool.classList.add('hidden');
        disable(ss, sess.school);
        selClass.classList.remove('hidden');
        selSection.classList.add('hidden');
      } else {
        inpNewSchool.classList.add('hidden');
        disable(ss, sess.school);
        selClass.innerHTML = '';
        disable(selClass, sess.cls);
        selSection.classList.remove('hidden');
        selSection.innerHTML = '';
        disable(selSection, sess.sec);
      }
    }

    document.getElementById('saveSetup').addEventListener('click', async ()=>{
      const school = document.getElementById('schoolSelect').value;
      const cls    = document.getElementById('classSelect').value;
      const sec    = document.getElementById('sectionSelect').value || null;
      if (!school||!cls||(await idbGet('session')).role==='Teacher'&&!sec) {
        return alert('تمام ضروری فیلڈز مکمل کریں۔');
      }
      await idbSet('setup', { school, cls, sec });
      document.getElementById('teacher-setup').classList.add('hidden');
      document.getElementById('mainApp').classList.remove('hidden');
      document.getElementById('appHeader').classList.remove('hidden');
      // now app.js can run
    });

    function disable(el, val) {
      el.append(new Option(val,val));
      el.value = val;
      el.disabled = true;
    }
  </script>

  <!-- then load your app.js -->
  <script type="module" src="app.js"></script>
</body>
</html>
