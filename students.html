<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Student Portal</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{font-family:system-ui;background:#f1f5f9;margin:0;padding:1rem}
.card{max-width:420px;margin:auto;background:#fff;padding:1.5rem;border-radius:12px}
input,button{width:100%;padding:.7rem;margin:.4rem 0;border-radius:8px}
button{background:#2563eb;color:#fff;border:none}
.hidden{display:none}
.stat{display:flex;justify-content:space-between;margin:.3rem 0}
.badge{padding:.3rem .8rem;border-radius:999px}
.ok{background:#dcfce7;color:#166534}
.due{background:#fee2e2;color:#991b1b}
.error{color:red}
</style>
</head>
<body>

<div class="card" id="login">
  <h2>Student Login</h2>
  <input id="schoolInput" placeholder="School Name">
  <input id="admInput" placeholder="Admission No">
  <button onclick="login()">Continue</button>
  <div id="error" class="error"></div>
</div>

<div class="card hidden" id="dash">
  <h2 id="name"></h2>
  <div class="stat"><span>Admission</span><span id="adm"></span></div>
  <div class="stat"><span>Class</span><span id="cls"></span></div>
  <div class="stat"><span>Section</span><span id="sec"></span></div>

  <hr>

  <div class="stat"><span>Present</span><span id="p"></span></div>
  <div class="stat"><span>Absent</span><span id="a"></span></div>
  <div class="stat"><span>Late</span><span id="l"></span></div>
  <div class="stat"><span>Leave</span><span id="lv"></span></div>
  <div class="stat"><span>Fine</span><span id="fine"></span></div>

  <div>Status: <span id="status" class="badge"></span></div>
</div>

<button onclick="debugDB()" style="display:block;margin:1rem auto">
DEBUG DATA
</button>

<script>
function openDB(){
  return new Promise((res,rej)=>{
    const r=indexedDB.open("schoolDB");
    r.onsuccess=()=>res(r.result);
    r.onerror=()=>rej();
  });
}

function read(db,store){
  return new Promise(res=>{
    const tx=db.transaction(store,"readonly");
    const os=tx.objectStore(store);
    os.getAll().onsuccess=e=>res(e.target.result);
  });
}

async function login(){
  error.textContent="";
  const school=schoolInput.value.trim();
  const adm=admInput.value.trim();

  const db=await openDB();

  const studentsRaw=(await read(db,"studentsBySchool"))[0];
  const attendanceRaw=(await read(db,"attendanceDatabySchool"))[0];

  if(!studentsRaw || !studentsRaw[school]){
    error.textContent="School not found";
    return;
  }

  let student=null;

  for(const cls in studentsRaw[school]){
    for(const sec in studentsRaw[school][cls]){
      for(const s of studentsRaw[school][cls][sec]){
        if(String(s.admissionNo)===adm){
          student=s;
        }
      }
    }
  }

  if(!student){
    error.textContent="Record not found";
    return;
  }

  login.classList.add("hidden");
  dash.classList.remove("hidden");

  name.textContent=student.name;
  adm.textContent=student.admissionNo;
  cls.textContent=student.class;
  sec.textContent=student.section;

  let P=0,A=0,L=0,LV=0,F=0;

  (attendanceRaw[school]||[]).forEach(r=>{
    if(String(r.admissionNo)===adm){
      if(r.status==="Present")P++;
      if(r.status==="Absent")A++;
      if(r.status==="Late")L++;
      if(r.status==="Leave")LV++;
      F+=Number(r.fine||0);
    }
  });

  p.textContent=P; a.textContent=A; l.textContent=L; lv.textContent=LV;
  fine.textContent=F;

  status.textContent=F===0?"Cleared":"Due";
  status.className="badge "+(F===0?"ok":"due");
}

async function debugDB(){
  const db=await openDB();
  console.log("STUDENTS:",(await read(db,"studentsBySchool"))[0]);
  console.log("ATTENDANCE:",(await read(db,"attendanceDatabySchool"))[0]);
  alert("Check console (F12)");
}
</script>
</body>
</html>
