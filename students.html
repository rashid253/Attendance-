<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Portal - Attendance Management</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        :root {
            --primary: #2196F3;
            --secondary: #4CAF50;
            --warning: #FF9800;
            --danger: #F44336;
            --dark: #333;
            --light: #f5f5f5;
            --gray: #757575;
            --border: #e0e0e0;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .login-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 400px;
            overflow: hidden;
            animation: slideIn 0.5s ease-out;
        }

        @keyframes slideIn {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .header {
            background: linear-gradient(to right, var(--primary), #1976D2);
            color: white;
            padding: 30px 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 5px;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .login-form {
            padding: 30px;
        }

        .input-group {
            margin-bottom: 20px;
            position: relative;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--dark);
            font-weight: 500;
        }

        .input-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s;
        }

        .input-group input:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
        }

        .input-group i {
            position: absolute;
            right: 15px;
            top: 40px;
            color: var(--gray);
        }

        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 14px;
            width: 100%;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }

        .btn:hover {
            background: #1976D2;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(33, 150, 243, 0.3);
        }

        .footer {
            text-align: center;
            padding: 20px;
            color: var(--gray);
            font-size: 14px;
            border-top: 1px solid var(--border);
        }

        .footer a {
            color: var(--primary);
            text-decoration: none;
        }

        .footer a:hover {
            text-decoration: underline;
        }

        .message {
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .error {
            background: #FFEBEE;
            color: var(--danger);
            border: 1px solid #FFCDD2;
        }

        /* Dashboard styles will be loaded after login */
    </style>
</head>
<body>
    <div class="login-container" id="loginContainer">
        <div class="header">
            <h1><i class="fas fa-user-graduate"></i> Student Portal</h1>
            <p>Access your attendance, diary, and reports</p>
        </div>
        
        <form class="login-form" id="loginForm">
            <div class="message error" id="errorMessage">
                <i class="fas fa-exclamation-circle"></i> Invalid admission number or password
            </div>
            
            <div class="input-group">
                <label for="admNo"><i class="fas fa-id-card"></i> Admission Number</label>
                <input type="text" id="admNo" placeholder="Enter your admission number" required>
                <i class="fas fa-user"></i>
            </div>
            
            <div class="input-group">
                <label for="password"><i class="fas fa-lock"></i> Password</label>
                <input type="password" id="password" placeholder="Enter your password" required>
                <i class="fas fa-key"></i>
            </div>
            
            <button type="submit" class="btn">
                <i class="fas fa-sign-in-alt"></i> Login to Student Portal
            </button>
        </form>
        
        <div class="footer">
            <p>First time? Your password is your admission number</p>
            <p>Need help? Contact your class teacher</p>
        </div>
    </div>

    <div class="dashboard-container" id="dashboardContainer" style="display: none;">
        <!-- Dashboard content will be loaded dynamically -->
    </div>

    <script>
        // Firebase configuration (same as in app.js)
        const firebaseConfig = {
            apiKey: "AIzaSyBsxâ€¦EpICEzA",
            authDomain: "attandace-management.firebaseapp.com",
            projectId: "attandace-management",
            storageBucket: "attandace-management.appspot.com",
            messagingSenderId: "222685278846",
            appId: "1:222685278846:web:aa3e37a42b76befb6f5e2f",
            measurementId: "G-V2MY85R73B",
            databaseURL: "https://attandace-management-default-rtdb.firebaseio.com",
        };

        // Initialize Firebase (will only initialize if not already initialized)
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const database = firebase.database();

        let currentStudent = null;
        let attendanceData = {};
        let paymentsData = {};

        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const admNo = document.getElementById('admNo').value.trim();
            const password = document.getElementById('password').value;
            
            // Default password is admission number
            const defaultPassword = admNo;
            
            if (password !== defaultPassword) {
                document.getElementById('errorMessage').style.display = 'block';
                return;
            }
            
            try {
                // Fetch student data from Firebase
                const snapshot = await database.ref('appData').once('value');
                const appData = snapshot.val();
                
                if (!appData || !appData.studentsBySchool) {
                    throw new Error('No student data found');
                }
                
                // Find student across all schools
                let foundStudent = null;
                let foundSchool = null;
                
                for (const [school, students] of Object.entries(appData.studentsBySchool)) {
                    const student = students.find(s => s.adm === admNo);
                    if (student) {
                        foundStudent = student;
                        foundSchool = school;
                        break;
                    }
                }
                
                if (!foundStudent) {
                    document.getElementById('errorMessage').style.display = 'block';
                    return;
                }
                
                currentStudent = foundStudent;
                currentStudent.school = foundSchool;
                
                // Load attendance and payments data for the student's school
                attendanceData = appData.attendanceDataBySchool[foundSchool] || {};
                paymentsData = appData.paymentsDataBySchool[foundSchool] || {};
                
                // Show dashboard
                showDashboard();
                
            } catch (error) {
                console.error('Login error:', error);
                document.getElementById('errorMessage').textContent = 'Server error. Please try again.';
                document.getElementById('errorMessage').style.display = 'block';
            }
        });

        function showDashboard() {
            document.getElementById('loginContainer').style.display = 'none';
            
            const dashboardHTML = `
                <div class="dashboard">
                    <div class="sidebar">
                        <div class="profile">
                            <div class="avatar">
                                <i class="fas fa-user-graduate"></i>
                            </div>
                            <h3>${currentStudent.name}</h3>
                            <p>Adm#: ${currentStudent.adm}</p>
                            <p>${currentStudent.cls} - ${currentStudent.sec}</p>
                            <p>${currentStudent.school}</p>
                        </div>
                        
                        <nav class="menu">
                            <a href="#" class="menu-item active" data-page="overview">
                                <i class="fas fa-home"></i> Overview
                            </a>
                            <a href="#" class="menu-item" data-page="attendance">
                                <i class="fas fa-calendar-check"></i> Attendance
                            </a>
                            <a href="#" class="menu-item" data-page="diary">
                                <i class="fas fa-book"></i> Student Diary
                            </a>
                            <a href="#" class="menu-item" data-page="fines">
                                <i class="fas fa-coins"></i> Fines & Payments
                            </a>
                            <a href="#" class="menu-item" data-page="reports">
                                <i class="fas fa-chart-bar"></i> Reports
                            </a>
                            <a href="#" class="menu-item" data-page="profile">
                                <i class="fas fa-user-cog"></i> Profile
                            </a>
                        </nav>
                        
                        <button class="logout-btn" id="logoutBtn">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </button>
                    </div>
                    
                    <div class="main-content">
                        <div class="top-bar">
                            <div class="breadcrumb">
                                <span id="pageTitle">Student Overview</span>
                            </div>
                            <div class="date-display">
                                ${new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}
                            </div>
                        </div>
                        
                        <div class="content-area" id="contentArea">
                            <!-- Dynamic content will be loaded here -->
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('dashboardContainer').innerHTML = dashboardHTML;
            document.getElementById('dashboardContainer').style.display = 'block';
            
            // Load default page
            loadPage('overview');
            
            // Add event listeners
            document.querySelectorAll('.menu-item').forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    document.querySelectorAll('.menu-item').forEach(i => i.classList.remove('active'));
                    this.classList.add('active');
                    loadPage(this.dataset.page);
                });
            });
            
            document.getElementById('logoutBtn').addEventListener('click', function() {
                currentStudent = null;
                document.getElementById('dashboardContainer').style.display = 'none';
                document.getElementById('loginContainer').style.display = 'block';
                document.getElementById('loginForm').reset();
            });
            
            // Add dashboard CSS
            const dashboardCSS = `
                <style>
                    .dashboard {
                        display: flex;
                        min-height: 100vh;
                        background: #f8f9fa;
                    }
                    
                    .sidebar {
                        width: 280px;
                        background: linear-gradient(to bottom, #2c3e50, #34495e);
                        color: white;
                        display: flex;
                        flex-direction: column;
                        box-shadow: 2px 0 10px rgba(0,0,0,0.1);
                    }
                    
                    .profile {
                        padding: 30px 20px;
                        text-align: center;
                        border-bottom: 1px solid rgba(255,255,255,0.1);
                    }
                    
                    .avatar {
                        width: 80px;
                        height: 80px;
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        border-radius: 50%;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        margin: 0 auto 15px;
                        font-size: 32px;
                    }
                    
                    .profile h3 {
                        margin: 10px 0 5px;
                        font-size: 18px;
                    }
                    
                    .profile p {
                        margin: 3px 0;
                        font-size: 14px;
                        opacity: 0.8;
                    }
                    
                    .menu {
                        flex: 1;
                        padding: 20px 0;
                    }
                    
                    .menu-item {
                        display: flex;
                        align-items: center;
                        gap: 15px;
                        padding: 15px 25px;
                        color: rgba(255,255,255,0.8);
                        text-decoration: none;
                        transition: all 0.3s;
                        border-left: 4px solid transparent;
                    }
                    
                    .menu-item:hover, .menu-item.active {
                        background: rgba(255,255,255,0.1);
                        color: white;
                        border-left-color: var(--primary);
                    }
                    
                    .menu-item i {
                        width: 20px;
                        text-align: center;
                    }
                    
                    .logout-btn {
                        background: rgba(255,255,255,0.1);
                        color: white;
                        border: none;
                        padding: 15px 25px;
                        text-align: left;
                        cursor: pointer;
                        display: flex;
                        align-items: center;
                        gap: 15px;
                        transition: all 0.3s;
                        margin: 20px;
                        border-radius: 8px;
                    }
                    
                    .logout-btn:hover {
                        background: rgba(255,255,255,0.2);
                    }
                    
                    .main-content {
                        flex: 1;
                        display: flex;
                        flex-direction: column;
                    }
                    
                    .top-bar {
                        background: white;
                        padding: 20px 30px;
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
                    }
                    
                    .breadcrumb {
                        font-size: 24px;
                        font-weight: 600;
                        color: var(--dark);
                    }
                    
                    .date-display {
                        color: var(--gray);
                        font-size: 14px;
                    }
                    
                    .content-area {
                        flex: 1;
                        padding: 30px;
                        overflow-y: auto;
                    }
                    
                    .stats-grid {
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                        gap: 20px;
                        margin-bottom: 30px;
                    }
                    
                    .stat-card {
                        background: white;
                        border-radius: 12px;
                        padding: 25px;
                        box-shadow: 0 5px 15px rgba(0,0,0,0.05);
                        display: flex;
                        align-items: center;
                        gap: 20px;
                        transition: transform 0.3s;
                    }
                    
                    .stat-card:hover {
                        transform: translateY(-5px);
                    }
                    
                    .stat-icon {
                        width: 60px;
                        height: 60px;
                        border-radius: 12px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 24px;
                        color: white;
                    }
                    
                    .stat-content {
                        flex: 1;
                    }
                    
                    .stat-value {
                        font-size: 32px;
                        font-weight: 700;
                        margin-bottom: 5px;
                    }
                    
                    .stat-label {
                        color: var(--gray);
                        font-size: 14px;
                    }
                    
                    .card {
                        background: white;
                        border-radius: 12px;
                        padding: 25px;
                        box-shadow: 0 5px 15px rgba(0,0,0,0.05);
                        margin-bottom: 30px;
                    }
                    
                    .card-header {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        margin-bottom: 20px;
                    }
                    
                    .card-title {
                        font-size: 20px;
                        font-weight: 600;
                        color: var(--dark);
                    }
                    
                    table {
                        width: 100%;
                        border-collapse: collapse;
                    }
                    
                    th {
                        background: #f8f9fa;
                        padding: 12px 15px;
                        text-align: left;
                        font-weight: 600;
                        color: var(--dark);
                        border-bottom: 2px solid var(--border);
                    }
                    
                    td {
                        padding: 12px 15px;
                        border-bottom: 1px solid var(--border);
                    }
                    
                    .status-badge {
                        padding: 5px 10px;
                        border-radius: 20px;
                        font-size: 12px;
                        font-weight: 600;
                    }
                    
                    .present { background: #E8F5E9; color: #2E7D32; }
                    .absent { background: #FFEBEE; color: #C62828; }
                    .late { background: #FFF8E1; color: #EF6C00; }
                    .paid { background: #E8F5E9; color: #2E7D32; }
                    .pending { background: #FFF3E0; color: #EF6C00; }
                    
                    .btn-small {
                        padding: 8px 16px;
                        border-radius: 6px;
                        border: none;
                        font-size: 14px;
                        cursor: pointer;
                        transition: all 0.3s;
                    }
                    
                    .btn-primary { background: var(--primary); color: white; }
                    .btn-secondary { background: var(--secondary); color: white; }
                    
                    .attendance-calendar {
                        display: grid;
                        grid-template-columns: repeat(7, 1fr);
                        gap: 5px;
                        margin-top: 20px;
                    }
                    
                    .calendar-day {
                        aspect-ratio: 1;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        border-radius: 8px;
                        font-weight: 600;
                        cursor: pointer;
                        transition: all 0.3s;
                    }
                    
                    .calendar-day:hover {
                        transform: scale(1.1);
                    }
                    
                    .empty-day { background: #f8f9fa; }
                    
                    .diary-entry {
                        background: white;
                        border: 1px solid var(--border);
                        border-radius: 8px;
                        padding: 20px;
                        margin-bottom: 15px;
                        cursor: pointer;
                        transition: all 0.3s;
                    }
                    
                    .diary-entry:hover {
                        border-color: var(--primary);
                        box-shadow: 0 5px 15px rgba(0,0,0,0.05);
                    }
                    
                    .diary-date {
                        color: var(--primary);
                        font-weight: 600;
                        margin-bottom: 10px;
                    }
                    
                    .diary-content {
                        color: var(--dark);
                        line-height: 1.6;
                    }
                    
                    .modal-overlay {
                        position: fixed;
                        top: 0;
                        left: 0;
                        right: 0;
                        bottom: 0;
                        background: rgba(0,0,0,0.5);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        z-index: 1000;
                    }
                    
                    .modal-content {
                        background: white;
                        border-radius: 12px;
                        width: 90%;
                        max-width: 600px;
                        max-height: 80vh;
                        overflow-y: auto;
                    }
                    
                    .modal-header {
                        padding: 20px;
                        border-bottom: 1px solid var(--border);
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                    }
                    
                    .modal-body {
                        padding: 20px;
                    }
                </style>
            `;
            
            document.head.insertAdjacentHTML('beforeend', dashboardCSS);
        }

        async function loadPage(page) {
            const contentArea = document.getElementById('contentArea');
            document.getElementById('pageTitle').textContent = getPageTitle(page);
            
            switch(page) {
                case 'overview':
                    contentArea.innerHTML = await loadOverview();
                    break;
                case 'attendance':
                    contentArea.innerHTML = await loadAttendance();
                    break;
                case 'diary':
                    contentArea.innerHTML = await loadDiary();
                    setupDiaryListeners();
                    break;
                case 'fines':
                    contentArea.innerHTML = await loadFines();
                    break;
                case 'reports':
                    contentArea.innerHTML = await loadReports();
                    break;
                case 'profile':
                    contentArea.innerHTML = await loadProfile();
                    break;
            }
        }

        function getPageTitle(page) {
            const titles = {
                'overview': 'Student Overview',
                'attendance': 'Attendance Records',
                'diary': 'Student Diary',
                'fines': 'Fines & Payments',
                'reports': 'Reports & Analytics',
                'profile': 'Profile Settings'
            };
            return titles[page] || 'Student Portal';
        }

        async function loadOverview() {
            const today = new Date().toISOString().split('T')[0];
            const stats = calculateStudentStats();
            
            return `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                            <i class="fas fa-percentage"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value">${stats.attendancePercentage}%</div>
                            <div class="stat-label">Attendance Percentage</div>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #4CAF50 0%, #2E7D32 100%);">
                            <i class="fas fa-calendar-check"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value">${stats.totalDays}</div>
                            <div class="stat-label">Total Days Tracked</div>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #FF9800 0%, #EF6C00 100%);">
                            <i class="fas fa-coins"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value">PKR ${stats.outstandingFine}</div>
                            <div class="stat-label">Outstanding Fine</div>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value">${stats.status}</div>
                            <div class="stat-label">Eligibility Status</div>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Recent Attendance</div>
                        <button class="btn-small btn-primary" onclick="loadPage('attendance')">
                            View All <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Status</th>
                                <th>Remarks</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${getRecentAttendance()}
                        </tbody>
                    </table>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Upcoming Events</div>
                    </div>
                    <div style="padding: 20px;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                            <div style="width: 10px; height: 10px; border-radius: 50%; background: var(--primary);"></div>
                            <div>Parent-Teacher Meeting - Tomorrow at 2:00 PM</div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                            <div style="width: 10px; height: 10px; border-radius: 50%; background: var(--secondary);"></div>
                            <div>Sports Day - Next Friday</div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div style="width: 10px; height: 10px; border-radius: 50%; background: var(--warning);"></div>
                            <div>Monthly Test - Next Week</div>
                        </div>
                    </div>
                </div>
            `;
        }

        function calculateStudentStats() {
            let present = 0, absent = 0, late = 0, halfDay = 0, leave = 0;
            
            Object.values(attendanceData).forEach(day => {
                const status = day[currentStudent.adm];
                if (status) {
                    switch(status) {
                        case 'P': present++; break;
                        case 'A': absent++; break;
                        case 'Lt': late++; break;
                        case 'HD': halfDay++; break;
                        case 'L': leave++; break;
                    }
                }
            });
            
            const totalDays = present + absent + late + halfDay + leave;
            const attendancePercentage = totalDays > 0 ? Math.round((present / totalDays) * 100) : 0;
            
            const fineRates = { A:50, Lt:20, L:10, HD:30 };
            const totalFine = (absent * fineRates.A) + (late * fineRates.Lt) + 
                            (leave * fineRates.L) + (halfDay * fineRates.HD);
            
            const payments = paymentsData[currentStudent.adm] || [];
            const paidAmount = payments.reduce((sum, payment) => sum + payment.amount, 0);
            const outstandingFine = Math.max(0, totalFine - paidAmount);
            
            const eligibilityPct = 75;
            const status = (outstandingFine > 0 || attendancePercentage < eligibilityPct) ? 'Debarred' : 'Eligible';
            
            return {
                present, absent, late, halfDay, leave,
                totalDays,
                attendancePercentage,
                totalFine,
                paidAmount,
                outstandingFine,
                status
            };
        }

        function getRecentAttendance() {
            const dates = Object.keys(attendanceData)
                .sort()
                .reverse()
                .slice(0, 5);
            
            return dates.map(date => {
                const status = attendanceData[date][currentStudent.adm] || 'A';
                const statusText = getStatusText(status);
                const statusClass = getStatusClass(status);
                
                return `
                    <tr>
                        <td>${formatDate(date)}</td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        <td>${getStatusRemarks(status)}</td>
                    </tr>
                `;
            }).join('');
        }

        function getStatusText(status) {
            const statusMap = { P: 'Present', A: 'Absent', Lt: 'Late', HD: 'Half Day', L: 'Leave' };
            return statusMap[status] || 'Unknown';
        }

        function getStatusClass(status) {
            const classMap = { P: 'present', A: 'absent', Lt: 'late', HD: 'warning', L: 'info' };
            return classMap[status] || 'absent';
        }

        function getStatusRemarks(status) {
            const remarks = {
                P: 'Attended all classes',
                A: 'Fine applicable',
                Lt: 'Late arrival',
                HD: 'Left early',
                L: 'Approved leave'
            };
            return remarks[status] || '';
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
        }

        async function loadAttendance() {
            const stats = calculateStudentStats();
            
            return `
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Attendance Summary</div>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; padding: 20px;">
                        <div style="text-align: center;">
                            <div style="font-size: 36px; font-weight: 700; color: #4CAF50;">${stats.present}</div>
                            <div style="color: var(--gray);">Present</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 36px; font-weight: 700; color: #F44336;">${stats.absent}</div>
                            <div style="color: var(--gray);">Absent</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 36px; font-weight: 700; color: #FF9800;">${stats.late}</div>
                            <div style="color: var(--gray);">Late</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 36px; font-weight: 700; color: #FF9800;">${stats.halfDay}</div>
                            <div style="color: var(--gray);">Half Day</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 36px; font-weight: 700; color: #2196F3;">${stats.leave}</div>
                            <div style="color: var(--gray);">Leave</div>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Attendance Calendar (Last 30 Days)</div>
                    </div>
                    <div class="attendance-calendar" id="attendanceCalendar">
                        ${generateAttendanceCalendar()}
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Detailed Attendance Records</div>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Day</th>
                                <th>Status</th>
                                <th>Fine</th>
                                <th>Remarks</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${getDetailedAttendance()}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function generateAttendanceCalendar() {
            const days = ['S', 'M', 'T', 'W', 'T', 'F', 'S'];
            let html = '';
            
            // Day headers
            days.forEach(day => {
                html += `<div class="calendar-day empty-day">${day}</div>`;
            });
            
            // Generate last 30 days
            const today = new Date();
            for (let i = 29; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(today.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                const day = date.getDate();
                
                const status = attendanceData[dateStr]?.[currentStudent.adm];
                let bgColor = '#f8f9fa';
                
                if (status) {
                    switch(status) {
                        case 'P': bgColor = '#4CAF50'; break;
                        case 'A': bgColor = '#F44336'; break;
                        case 'Lt': bgColor = '#FF9800'; break;
                        case 'HD': bgColor = '#FFC107'; break;
                        case 'L': bgColor = '#2196F3'; break;
                    }
                }
                
                html += `
                    <div class="calendar-day" style="background: ${bgColor}; color: ${status ? 'white' : 'var(--dark)'};" 
                         title="${dateStr}: ${getStatusText(status || 'N/A')}">
                        ${day}
                    </div>
                `;
            }
            
            return html;
        }

        function getDetailedAttendance() {
            const dates = Object.keys(attendanceData).sort().reverse();
            const fineRates = { A:50, Lt:20, L:10, HD:30 };
            
            return dates.map(date => {
                const status = attendanceData[date][currentStudent.adm] || 'A';
                const statusText = getStatusText(status);
                const statusClass = getStatusClass(status);
                const fine = fineRates[status] || 0;
                const dayName = new Date(date).toLocaleDateString('en-US', { weekday: 'long' });
                
                return `
                    <tr>
                        <td>${date}</td>
                        <td>${dayName}</td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        <td>${fine > 0 ? `PKR ${fine}` : '-'}</td>
                        <td>${getStatusRemarks(status)}</td>
                    </tr>
                `;
            }).join('');
        }

        async function loadDiary() {
            return `
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Student Diary</div>
                        <button class="btn-small btn-primary" id="addDiaryEntry">
                            <i class="fas fa-plus"></i> Add Entry
                        </button>
                    </div>
                    <div id="diaryEntries">
                        <p style="text-align: center; padding: 40px; color: var(--gray);">
                            <i class="fas fa-book-open" style="font-size: 48px; margin-bottom: 15px; display: block;"></i>
                            No diary entries yet. Click "Add Entry" to start your diary.
                        </p>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Homework & Assignments</div>
                    </div>
                    <div style="padding: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid var(--border);">
                            <div>
                                <div style="font-weight: 600; margin-bottom: 5px;">Mathematics Chapter 5 Exercises</div>
                                <div style="font-size: 14px; color: var(--gray);">Due: Tomorrow</div>
                            </div>
                            <span class="status-badge pending">Pending</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid var(--border);">
                            <div>
                                <div style="font-weight: 600; margin-bottom: 5px;">Science Project Report</div>
                                <div style="font-size: 14px; color: var(--gray);">Due: Next Monday</div>
                            </div>
                            <span class="status-badge pending">In Progress</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div>
                                <div style="font-weight: 600; margin-bottom: 5px;">English Essay Writing</div>
                                <div style="font-size: 14px; color: var(--gray);">Due: Next Friday</div>
                            </div>
                            <span class="status-badge paid">Completed</span>
                        </div>
                    </div>
                </div>
            `;
        }

        function setupDiaryListeners() {
            document.getElementById('addDiaryEntry').addEventListener('click', showDiaryEditor);
            loadDiaryEntries();
        }

        function showDiaryEditor() {
            const modalHTML = `
                <div class="modal-overlay" id="diaryModal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3 style="margin: 0;">New Diary Entry</h3>
                            <button id="closeModal" style="background: none; border: none; font-size: 20px; cursor: pointer; color: var(--gray);">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 600;">Date</label>
                                <input type="date" id="diaryDate" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px;" 
                                       value="${new Date().toISOString().split('T')[0]}">
                            </div>
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 600;">Title</label>
                                <input type="text" id="diaryTitle" placeholder="What's on your mind?" 
                                       style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px;">
                            </div>
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 600;">Content</label>
                                <textarea id="diaryContent" rows="8" placeholder="Write your diary entry here..." 
                                          style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; resize: vertical;"></textarea>
                            </div>
                            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                                <button id="cancelDiary" class="btn-small" style="background: #f8f9fa; color: var(--dark);">Cancel</button>
                                <button id="saveDiary" class="btn-small btn-primary">Save Entry</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            document.getElementById('closeModal').addEventListener('click', closeDiaryModal);
            document.getElementById('cancelDiary').addEventListener('click', closeDiaryModal);
            document.getElementById('saveDiary').addEventListener('click', saveDiaryEntry);
        }

        function closeDiaryModal() {
            document.getElementById('diaryModal').remove();
        }

        function saveDiaryEntry() {
            const date = document.getElementById('diaryDate').value;
            const title = document.getElementById('diaryTitle').value;
            const content = document.getElementById('diaryContent').value;
            
            if (!title || !content) {
                alert('Please fill in all fields');
                return;
            }
            
            // Save to localStorage (in real app, save to Firebase)
            const entries = JSON.parse(localStorage.getItem(`diary_${currentStudent.adm}`) || '[]');
            entries.unshift({
                id: Date.now(),
                date,
                title,
                content,
                createdAt: new Date().toISOString()
            });
            
            localStorage.setItem(`diary_${currentStudent.adm}`, JSON.stringify(entries));
            closeDiaryModal();
            loadDiaryEntries();
        }

        function loadDiaryEntries() {
            const entries = JSON.parse(localStorage.getItem(`diary_${currentStudent.adm}`) || '[]');
            const container = document.getElementById('diaryEntries');
            
            if (entries.length === 0) {
                container.innerHTML = `
                    <p style="text-align: center; padding: 40px; color: var(--gray);">
                        <i class="fas fa-book-open" style="font-size: 48px; margin-bottom: 15px; display: block;"></i>
                        No diary entries yet. Click "Add Entry" to start your diary.
                    </p>
                `;
                return;
            }
            
            container.innerHTML = entries.map(entry => `
                <div class="diary-entry" data-id="${entry.id}">
                    <div class="diary-date">
                        <i class="fas fa-calendar-day"></i> ${formatDate(entry.date)}
                        ${entry.title ? `<span style="margin-left: 10px; font-weight: 600;">${entry.title}</span>` : ''}
                    </div>
                    <div class="diary-content">${entry.content}</div>
                </div>
            `).join('');
        }

        async function loadFines() {
            const stats = calculateStudentStats();
            const payments = paymentsData[currentStudent.adm] || [];
            
            return `
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Fine Summary</div>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; padding: 20px;">
                        <div style="text-align: center; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 12px;">
                            <div style="font-size: 36px; font-weight: 700;">PKR ${stats.totalFine}</div>
                            <div>Total Fine</div>
                        </div>
                        <div style="text-align: center; padding: 20px; background: linear-gradient(135deg, #4CAF50 0%, #2E7D32 100%); color: white; border-radius: 12px;">
                            <div style="font-size: 36px; font-weight: 700;">PKR ${stats.paidAmount}</div>
                            <div>Total Paid</div>
                        </div>
                        <div style="text-align: center; padding: 20px; background: linear-gradient(135deg, ${stats.outstandingFine > 0 ? '#F44336' : '#FF9800'} 0%, ${stats.outstandingFine > 0 ? '#C62828' : '#EF6C00'} 100%); color: white; border-radius: 12px;">
                            <div style="font-size: 36px; font-weight: 700;">PKR ${stats.outstandingFine}</div>
                            <div>Outstanding</div>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Fine Breakdown</div>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Type</th>
                                <th>Count</th>
                                <th>Rate (PKR)</th>
                                <th>Amount (PKR)</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Absent</td>
                                <td>${stats.absent}</td>
                                <td>50</td>
                                <td>PKR ${stats.absent * 50}</td>
                            </tr>
                            <tr>
                                <td>Late</td>
                                <td>${stats.late}</td>
                                <td>20</td>
                                <td>PKR ${stats.late * 20}</td>
                            </tr>
                            <tr>
                                <td>Leave</td>
                                <td>${stats.leave}</td>
                                <td>10</td>
                                <td>PKR ${stats.leave * 10}</td>
                            </tr>
                            <tr>
                                <td>Half Day</td>
                                <td>${stats.halfDay}</td>
                                <td>30</td>
                                <td>PKR ${stats.halfDay * 30}</td>
                            </tr>
                            <tr style="font-weight: 600; background: #f8f9fa;">
                                <td colspan="3">Total Fine</td>
                                <td>PKR ${stats.totalFine}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Payment History</div>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Amount (PKR)</th>
                                <th>Mode</th>
                                <th>Receipt</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${payments.length > 0 ? payments.map(payment => `
                                <tr>
                                    <td>${payment.date}</td>
                                    <td>PKR ${payment.amount}</td>
                                    <td>Cash</td>
                                    <td>
                                        <button class="btn-small" style="background: #f8f9fa; color: var(--dark);">
                                            <i class="fas fa-receipt"></i> View
                                        </button>
                                    </td>
                                </tr>
                            `).join('') : `
                                <tr>
                                    <td colspan="4" style="text-align: center; padding: 20px; color: var(--gray);">
                                        No payment records found
                                    </td>
                                </tr>
                            `}
                        </tbody>
                    </table>
                </div>
            `;
        }

        async function loadReports() {
            return `
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Monthly Attendance Report</div>
                        <button class="btn-small btn-primary">
                            <i class="fas fa-download"></i> Download PDF
                        </button>
                    </div>
                    <div style="padding: 20px;">
                        <div style="width: 100%; height: 300px;" id="attendanceChart">
                            <canvas id="attendanceChartCanvas"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Performance Trends</div>
                    </div>
                    <div style="padding: 20px;">
                        <div style="display: flex; gap: 30px; margin-bottom: 30px;">
                            <div style="flex: 1;">
                                <div style="font-size: 14px; color: var(--gray); margin-bottom: 5px;">Attendance Trend</div>
                                <div style="font-size: 24px; font-weight: 700; color: var(--primary);">
                                    ${calculateStudentStats().attendancePercentage}%
                                </div>
                                <div style="height: 4px; background: #f0f0f0; margin-top: 10px; border-radius: 2px;">
                                    <div style="width: ${calculateStudentStats().attendancePercentage}%; height: 100%; background: var(--primary); border-radius: 2px;"></div>
                                </div>
                            </div>
                            <div style="flex: 1;">
                                <div style="font-size: 14px; color: var(--gray); margin-bottom: 5px;">Fine Clearance</div>
                                <div style="font-size: 24px; font-weight: 700; color: var(--secondary);">
                                    ${calculateStudentStats().outstandingFine === 0 ? '100%' : 
                                      Math.round(((calculateStudentStats().totalFine - calculateStudentStats().outstandingFine) / calculateStudentStats().totalFine) * 100)}%
                                </div>
                                <div style="height: 4px; background: #f0f0f0; margin-top: 10px; border-radius: 2px;">
                                    <div style="width: ${calculateStudentStats().outstandingFine === 0 ? '100' : 
                                      Math.round(((calculateStudentStats().totalFine - calculateStudentStats().outstandingFine) / calculateStudentStats().totalFine) * 100)}%; height: 100%; background: var(--secondary); border-radius: 2px;"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
                            <div style="font-weight: 600; margin-bottom: 15px;">Recommendations</div>
                            ${calculateStudentStats().attendancePercentage < 75 ? `
                                <div style="display: flex; align-items: start; gap: 10px; margin-bottom: 10px;">
                                    <i class="fas fa-exclamation-triangle" style="color: #FF9800;"></i>
                                    <div>Improve attendance to maintain eligibility (currently ${calculateStudentStats().attendancePercentage}%)</div>
                                </div>
                            ` : ''}
                            ${calculateStudentStats().outstandingFine > 0 ? `
                                <div style="display: flex; align-items: start; gap: 10px; margin-bottom: 10px;">
                                    <i class="fas fa-exclamation-triangle" style="color: #F44336;"></i>
                                    <div>Clear outstanding fine of PKR ${calculateStudentStats().outstandingFine}</div>
                                </div>
                            ` : ''}
                            ${calculateStudentStats().late > 5 ? `
                                <div style="display: flex; align-items: start; gap: 10px;">
                                    <i class="fas fa-clock" style="color: #2196F3;"></i>
                                    <div>Reduce late arrivals (${calculateStudentStats().late} instances this term)</div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        async function loadProfile() {
            return `
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Personal Information</div>
                        <button class="btn-small" style="background: #f8f9fa; color: var(--dark);">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 20px; padding: 20px;">
                        <div style="text-align: center;">
                            <div style="width: 120px; height: 120px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                                        border-radius: 50%; display: flex; align-items: center; justify-content: center; 
                                        margin: 0 auto 20px; font-size: 48px; color: white;">
                                <i class="fas fa-user-graduate"></i>
                            </div>
                            <button class="btn-small" style="width: 100%;">Change Photo</button>
                        </div>
                        <div>
                            <table style="width: 100%;">
                                <tr>
                                    <td style="padding: 10px 0; color: var(--gray);">Full Name</td>
                                    <td style="padding: 10px 0; font-weight: 600;">${currentStudent.name}</td>
                                </tr>
                                <tr>
                                    <td style="padding: 10px 0; color: var(--gray);">Admission Number</td>
                                    <td style="padding: 10px 0; font-weight: 600;">${currentStudent.adm}</td>
                                </tr>
                                <tr>
                                    <td style="padding: 10px 0; color: var(--gray);">Class & Section</td>
                                    <td style="padding: 10px 0; font-weight: 600;">${currentStudent.cls} - ${currentStudent.sec}</td>
                                </tr>
                                <tr>
                                    <td style="padding: 10px 0; color: var(--gray);">School</td>
                                    <td style="padding: 10px 0; font-weight: 600;">${currentStudent.school}</td>
                                </tr>
                                <tr>
                                    <td style="padding: 10px 0; color: var(--gray);">Parent Name</td>
                                    <td style="padding: 10px 0;">${currentStudent.parent}</td>
                                </tr>
                                <tr>
                                    <td style="padding: 10px 0; color: var(--gray);">Contact</td>
                                    <td style="padding: 10px 0;">${currentStudent.contact}</td>
                                </tr>
                                <tr>
                                    <td style="padding: 10px 0; color: var(--gray);">Address</td>
                                    <td style="padding: 10px 0;">${currentStudent.address}</td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Account Settings</div>
                    </div>
                    <div style="padding: 20px;">
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">Change Password</label>
                            <input type="password" placeholder="Current password" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; margin-bottom: 10px;">
                            <input type="password" placeholder="New password" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; margin-bottom: 10px;">
                            <input type="password" placeholder="Confirm new password" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px;">
                            <button class="btn-small btn-primary" style="margin-top: 15px;">Update Password</button>
                        </div>
                        
                        <div style="border-top: 1px solid var(--border); padding-top: 20px;">
                            <div style="font-weight: 600; margin-bottom: 15px;">Notification Preferences</div>
                            <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                                <input type="checkbox" checked>
                                <span>Attendance alerts</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                                <input type="checkbox" checked>
                                <span>Fine updates</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox">
                                <span>Homework reminders</span>
                            </label>
                        </div>
                    </div>
                </div>
            `;
        }
    </script>
</body>
</html>
