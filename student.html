<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Student Portal</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="theme-color" content="#0f172a">
<meta name="mobile-web-app-capable" content="yes">

<link rel="stylesheet"
 href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

<script src="https://cdn.jsdelivr.net/npm/idb-keyval@6/dist/idb-keyval.iife.min.js"></script>

<style>
body{
  margin:0;
  font-family:system-ui;
  background:#f1f5f9
}
header{
  background:#0f172a;
  color:#fff;
  padding:1rem;
  text-align:center
}
section{
  padding:1rem
}
input,button{
  width:100%;
  padding:.7rem;
  margin:.4rem 0;
  border-radius:6px;
  font-size:1rem
}
input{
  border:1px solid #cbd5e1
}
button{
  border:none;
  background:#2563eb;
  color:#fff;
  cursor:pointer
}
.card{
  background:#fff;
  padding:1rem;
  margin-bottom:1rem;
  border-radius:8px;
  box-shadow:0 2px 6px rgba(0,0,0,.08)
}
.hidden{
  display:none
}
.error{
  color:red
}
.badge{
  padding:.3rem .7rem;
  border-radius:20px;
  font-size:.9rem
}
.ok{
  background:#dcfce7;
  color:#166534
}
.due{
  background:#fee2e2;
  color:#991b1b
}
</style>
</head>

<body>

<header>
  <h2><i class="fas fa-user-graduate"></i> Student Portal</h2>
</header>

<section id="loginSection">
  <h3>Access Your Record</h3>
  <input id="schoolInput" placeholder="School Name">
  <input id="admInput" placeholder="Admission Number">
  <button onclick="login()">Continue</button>
  <p class="error" id="errorMsg"></p>
</section>

<section id="dashboard" class="hidden">

  <div class="card">
    <h4>Student Info</h4>
    <p><b>Name:</b> <span id="stName"></span></p>
    <p><b>Admission #:</b> <span id="stAdm"></span></p>
    <p><b>Class:</b> <span id="stClass"></span></p>
    <p><b>Section:</b> <span id="stSection"></span></p>
  </div>

  <div class="card">
    <h4>Attendance Summary</h4>
    <p>Present: <span id="p"></span></p>
    <p>Absent: <span id="a"></span></p>
    <p>Late: <span id="l"></span></p>
    <p>Leave: <span id="lv"></span></p>
  </div>

  <div class="card">
    <h4>Financial</h4>
    <p>Total Fine: <b><span id="fine"></span></b></p>
    <p>Status:
      <span id="statusBadge" class="badge"></span>
    </p>
  </div>

  <button onclick="location.reload()">Logout</button>
</section>

<button onclick="debugDB()" style="margin:1rem">
  DEBUG: Show Stored Keys
</button>

<script>
const { get, keys } = idbKeyval;

async function login(){
  errorMsg.textContent = "";

  const school = schoolInput.value.trim();
  const adm = admInput.value.trim();

  if(!school || !adm){
    errorMsg.textContent = "Both fields are required";
    return;
  }

  const studentsBySchool = await get("studentsBySchool") || {};
  const attendanceBySchool = await get("attendanceDatabySchool") || {};

  let student = null;
  let attendanceList = [];

  if(studentsBySchool[school]){
    for(const cls in studentsBySchool[school]){
      for(const sec in studentsBySchool[school][cls]){
        const arr = studentsBySchool[school][cls][sec] || [];
        const st = arr.find(s =>
          String(s.admissionNo) === String(adm)
        );
        if(st){
          student = st;
          attendanceList =
            attendanceBySchool?.[school]?.[cls]?.[sec] || [];
          break;
        }
      }
      if(student) break;
    }
  }

  if(!student){
    errorMsg.textContent = "Record not found";
    return;
  }

  loginSection.classList.add("hidden");
  dashboard.classList.remove("hidden");

  stName.textContent = student.name;
  stAdm.textContent = student.admissionNo;
  stClass.textContent = student.class;
  stSection.textContent = student.section;

  let P=0,A=0,L=0,LV=0,F=0;

  attendanceList.forEach(r=>{
    if(String(r.admissionNo) === String(student.admissionNo)){
      if(r.status==="Present") P++;
      if(r.status==="Absent") A++;
      if(r.status==="Late") L++;
      if(r.status==="Leave") LV++;
      F += Number(r.fine || 0);
    }
  });

  p.textContent = P;
  a.textContent = A;
  l.textContent = L;
  lv.textContent = LV;
  fine.textContent = F;

  const badge = document.getElementById("statusBadge");
  if(F === 0){
    badge.textContent = "Cleared";
    badge.className = "badge ok";
  }else{
    badge.textContent = "Due";
    badge.className = "badge due";
  }
}

async function debugDB(){
  const k = await keys();
  alert("Stored Keys:\n\n" + k.join("\n"));
  console.log("ALL KEYS:", k);
}
</script>

</body>
</html>
