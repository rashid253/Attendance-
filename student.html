<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Student Portal</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- ✅ idb-keyval MUST be loaded first (IIFE version, no modules) -->
<script src="https://cdn.jsdelivr.net/npm/idb-keyval@6/dist/idb-keyval.iife.min.js"></script>

<style>
body{
  font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
  background:#f3f4f6;
  margin:0;
  padding:1rem;
}
.card{
  max-width:420px;
  margin:auto;
  background:#fff;
  border-radius:14px;
  padding:1.5rem;
  box-shadow:0 10px 25px rgba(0,0,0,.08);
}
h2{margin-top:0}
input,button{
  width:100%;
  padding:.75rem;
  margin:.5rem 0;
  border-radius:8px;
  border:1px solid #ccc;
  font-size:1rem;
}
button{
  background:#2563eb;
  color:#fff;
  border:none;
  cursor:pointer;
}
button:active{transform:scale(.98)}
.hidden{display:none}
.error{color:#dc2626;margin-top:.5rem}
.stat{
  display:flex;
  justify-content:space-between;
  margin:.35rem 0;
}
.badge{
  padding:.3rem .8rem;
  border-radius:999px;
  font-size:.85rem;
}
.badge.ok{background:#dcfce7;color:#166534}
.badge.due{background:#fee2e2;color:#991b1b}
</style>
</head>

<body>

<!-- LOGIN -->
<div class="card" id="loginSection">
  <h2>Student Login</h2>
  <input id="schoolInput" placeholder="School Name">
  <input id="admInput" placeholder="Admission No">
  <button onclick="login()">Login</button>
  <div id="errorMsg" class="error"></div>
</div>

<!-- DASHBOARD -->
<div class="card hidden" id="dashboard">
  <h2 id="stName"></h2>

  <div class="stat"><span>Admission</span><span id="stAdm"></span></div>
  <div class="stat"><span>Class</span><span id="stClass"></span></div>
  <div class="stat"><span>Section</span><span id="stSection"></span></div>

  <hr>

  <div class="stat"><span>Present</span><span id="p"></span></div>
  <div class="stat"><span>Absent</span><span id="a"></span></div>
  <div class="stat"><span>Late</span><span id="l"></span></div>
  <div class="stat"><span>Leave</span><span id="lv"></span></div>
  <div class="stat"><span>Fine</span><span id="fine"></span></div>

  <div style="margin-top:1rem">
    Status:
    <span id="statusBadge" class="badge"></span>
  </div>
</div>

<!-- DEBUG BUTTON (OPTIONAL) -->
<button onclick="debugDB()" style="margin:1rem auto;display:block">
  DEBUG: Show Stored Keys
</button>

<script>
/* ✅ SAFE ACCESS (no destructuring before load) */
async function login(){
  const errorMsg = document.getElementById("errorMsg");
  errorMsg.textContent = "";

  const school = document.getElementById("schoolInput").value.trim();
  const adm = document.getElementById("admInput").value.trim();

  if(!school || !adm){
    errorMsg.textContent = "Both fields are required";
    return;
  }

  const studentsBySchool =
    await idbKeyval.get("studentsBySchool") || {};

  const attendanceBySchool =
    await idbKeyval.get("attendanceDatabySchool") || {};

  let found = null;
  let records = [];

  if(studentsBySchool[school]){
    for(const cls in studentsBySchool[school]){
      for(const sec in studentsBySchool[school][cls]){
        const list = studentsBySchool[school][cls][sec] || [];
        const s = list.find(x => String(x.admissionNo) === String(adm));
        if(s){
          found = s;
          records = attendanceBySchool?.[school]?.[cls]?.[sec] || [];
          break;
        }
      }
      if(found) break;
    }
  }

  if(!found){
    errorMsg.textContent = "Record not found";
    return;
  }

  document.getElementById("loginSection").classList.add("hidden");
  document.getElementById("dashboard").classList.remove("hidden");

  stName.textContent = found.name;
  stAdm.textContent = found.admissionNo;
  stClass.textContent = found.class;
  stSection.textContent = found.section;

  let P=0,A=0,L=0,LV=0,F=0;

  records.forEach(r=>{
    if(String(r.admissionNo) === String(found.admissionNo)){
      if(r.status==="Present") P++;
      if(r.status==="Absent") A++;
      if(r.status==="Late") L++;
      if(r.status==="Leave") LV++;
      F += Number(r.fine||0);
    }
  });

  p.textContent=P;
  a.textContent=A;
  l.textContent=L;
  lv.textContent=LV;
  fine.textContent=F;

  const badge=document.getElementById("statusBadge");
  if(F===0){
    badge.textContent="Cleared";
    badge.className="badge ok";
  }else{
    badge.textContent="Due";
    badge.className="badge due";
  }
}

/* ✅ DEBUG — NO keys() ERROR */
async function debugDB(){
  const keys = await idbKeyval.keys();
  alert("Stored Keys:\n\n"+keys.join("\n"));
  console.log("DB KEYS:", keys);
}
</script>

</body>
</html>
