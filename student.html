<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Student Portal</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{
  font-family: system-ui,sans-serif;
  background:#f1f5f9;
  margin:0;
  padding:1rem;
}
.card{
  max-width:420px;
  margin:auto;
  background:#fff;
  border-radius:14px;
  padding:1.5rem;
  box-shadow:0 10px 25px rgba(0,0,0,.08);
}
h2{margin-top:0}
input,button{
  width:100%;
  padding:.75rem;
  margin:.5rem 0;
  border-radius:8px;
  border:1px solid #cbd5e1;
  font-size:1rem;
}
button{
  background:#2563eb;
  color:#fff;
  border:none;
  cursor:pointer;
}
button:active{transform:scale(.98)}
.hidden{display:none}
.error{color:#dc2626;margin-top:.5rem}
.stat{
  display:flex;
  justify-content:space-between;
  margin:.35rem 0;
}
.badge{
  padding:.3rem .8rem;
  border-radius:999px;
  font-size:.85rem;
}
.badge.ok{background:#dcfce7;color:#166534}
.badge.due{background:#fee2e2;color:#991b1b}
</style>
</head>
<body>

<!-- LOGIN -->
<div class="card" id="loginSection">
  <h2>Student Login</h2>
  <input id="schoolInput" placeholder="School Name">
  <input id="admInput" placeholder="Admission No">
  <button onclick="login()">Login</button>
  <div id="errorMsg" class="error"></div>
</div>

<!-- DASHBOARD -->
<div class="card hidden" id="dashboard">
  <h2 id="stName"></h2>

  <div class="stat"><span>Admission</span><span id="stAdm"></span></div>
  <div class="stat"><span>Class</span><span id="stClass"></span></div>
  <div class="stat"><span>Section</span><span id="stSection"></span></div>

  <hr>

  <div class="stat"><span>Present</span><span id="p"></span></div>
  <div class="stat"><span>Absent</span><span id="a"></span></div>
  <div class="stat"><span>Late</span><span id="l"></span></div>
  <div class="stat"><span>Leave</span><span id="lv"></span></div>
  <div class="stat"><span>Fine</span><span id="fine"></span></div>

  <div style="margin-top:1rem">
    Status: <span id="statusBadge" class="badge"></span>
  </div>
</div>

<!-- DEBUG BUTTON -->
<button onclick="debugDB()" style="margin:1rem auto;display:block">
  DEBUG: Show Stored Data
</button>

<script>
/* ---------- IndexedDB helpers ---------- */
function openDB(){
  return new Promise((resolve,reject)=>{
    const req=indexedDB.open("schoolDB",1);
    req.onupgradeneeded=function(e){
      const db=e.target.result;
      if(!db.objectStoreNames.contains("studentsBySchool")){
        db.createObjectStore("studentsBySchool",{keyPath:"id",autoIncrement:true});
      }
      if(!db.objectStoreNames.contains("attendanceDatabySchool")){
        db.createObjectStore("attendanceDatabySchool",{keyPath:"id",autoIncrement:true});
      }
    }
    req.onsuccess=()=>resolve(req.result);
    req.onerror=()=>reject("DB error");
  });
}

function readStoreAll(db,store){
  return new Promise(resolve=>{
    if(!db.objectStoreNames.contains(store)){
      resolve([]);
      return;
    }
    const tx=db.transaction(store,"readonly");
    const os=tx.objectStore(store);
    const rq=os.getAll();
    rq.onsuccess=()=>resolve(rq.result);
    rq.onerror=()=>resolve([]);
  });
}

/* ---------- LOGIN ---------- */
async function login(){
  const errorMsg=document.getElementById("errorMsg");
  errorMsg.textContent="";

  const school=schoolInput.value.trim();
  const adm=admInput.value.trim();

  if(!school||!adm){
    errorMsg.textContent="Both fields are required";
    return;
  }

  const db=await openDB();
  const studentsRecords=await readStoreAll(db,"studentsBySchool");
  const attendanceRecords=await readStoreAll(db,"attendanceDatabySchool");

  let student=null;

  // Find student by school + admissionNo
  for(const s of studentsRecords){
    if(s.school===school && String(s.admissionNo)===String(adm)){
      student=s;
      break;
    }
  }

  if(!student){
    errorMsg.textContent="Record not found";
    return;
  }

  // Filter attendance for this student
  const records=attendanceRecords.filter(r=>r.school===school && String(r.admissionNo)===String(adm));

  loginSection.classList.add("hidden");
  dashboard.classList.remove("hidden");

  stName.textContent=student.name;
  stAdm.textContent=student.admissionNo;
  stClass.textContent=student.class;
  stSection.textContent=student.section;

  let P=0,A=0,L=0,LV=0,F=0;
  records.forEach(r=>{
    if(r.status==="Present")P++;
    if(r.status==="Absent")A++;
    if(r.status==="Late")L++;
    if(r.status==="Leave")LV++;
    F+=Number(r.fine||0);
  });

  p.textContent=P;
  a.textContent=A;
  l.textContent=L;
  lv.textContent=LV;
  fine.textContent=F;

  const badge=statusBadge;
  if(F===0){
    badge.textContent="Cleared";
    badge.className="badge ok";
  }else{
    badge.textContent="Due";
    badge.className="badge due";
  }
}

/* ---------- DEBUG ---------- */
async function debugDB(){
  const db=await openDB();
  alert("Object Stores:\n\n"+[...db.objectStoreNames].join("\n"));
  const students=await readStoreAll(db,"studentsBySchool");
  console.log("STUDENTS:", students);
  const attendance=await readStoreAll(db,"attendanceDatabySchool");
  console.log("ATTENDANCE:", attendance);
}
</script>
</body>
</html>
