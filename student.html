<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Student Portal</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="theme-color" content="#0f172a">
<meta name="mobile-web-app-capable" content="yes">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

<style>
body{margin:0;font-family:system-ui;background:#f1f5f9}
header{background:#0f172a;color:#fff;padding:1rem;text-align:center}
section{padding:1rem}
input,button{width:100%;padding:.7rem;margin:.4rem 0;border-radius:6px;font-size:1rem}
input{border:1px solid #cbd5e1}
button{border:none;background:#2563eb;color:#fff}
.card{background:#fff;padding:1rem;margin-bottom:1rem;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,.08)}
.hidden{display:none}
.error{color:red}
</style>
</head>

<body>

<header>
  <h2><i class="fas fa-user-graduate"></i> Student Portal</h2>
</header>

<section id="loginSection">
  <h3>Access Your Record</h3>
  <input id="schoolInput" placeholder="School Name">
  <input id="admInput" placeholder="Admission Number">
  <button id="loginBtn">Continue</button>
  <p class="error" id="errorMsg"></p>
</section>

<section id="dashboard" class="hidden">

  <div class="card">
    <h4>Student Info</h4>
    <p><b>Name:</b> <span id="stName"></span></p>
    <p><b>Admission #:</b> <span id="stAdm"></span></p>
    <p><b>Class:</b> <span id="stClass"></span></p>
    <p><b>Section:</b> <span id="stSection"></span></p>
  </div>

  <div class="card">
    <h4>Attendance Summary</h4>
    <p>Present: <span id="p"></span></p>
    <p>Absent: <span id="a"></span></p>
    <p>Late: <span id="l"></span></p>
    <p>Leave: <span id="lv"></span></p>
  </div>

  <div class="card">
    <h4>Financial</h4>
    <p>Total Fine: <b><span id="fine"></span></b></p>
    <p>Status: <b><span id="status"></span></b></p>
  </div>

  <button onclick="location.reload()">Logout</button>
</section>

<script>
const loginBtn = document.getElementById("loginBtn");
const errorMsg = document.getElementById("errorMsg");

loginBtn.addEventListener("click", login);

function openDB(){
  return new Promise((resolve,reject)=>{
    const req = indexedDB.open("attendanceDB");
    req.onerror = () => reject("DB error");
    req.onsuccess = () => resolve(req.result);
  });
}

function getAll(db, store){
  return new Promise(resolve=>{
    if(!db.objectStoreNames.contains(store)){
      resolve([]);
      return;
    }
    const tx = db.transaction(store,"readonly");
    const os = tx.objectStore(store);
    const rq = os.getAll();
    rq.onsuccess = () => resolve(rq.result || []);
  });
}

async function login(){
  errorMsg.textContent = "";

  const school = document.getElementById("schoolInput").value.trim();
  const adm = document.getElementById("admInput").value.trim();

  if(!school || !adm){
    errorMsg.textContent = "Both fields are required";
    return;
  }

  const db = await openDB();
  const students = await getAll(db,"students");

  const st = students.find(s =>
    s.school === school && String(s.admissionNo) === adm
  );

  if(!st){
    errorMsg.textContent = "Record not found";
    return;
  }

  document.getElementById("loginSection").classList.add("hidden");
  document.getElementById("dashboard").classList.remove("hidden");

  stName.textContent = st.name;
  stAdm.textContent = st.admissionNo;
  stClass.textContent = st.class;
  stSection.textContent = st.section;

  const attendance = await getAll(db,"attendance");

  let P=0,A=0,L=0,LV=0,F=0;

  attendance.forEach(r=>{
    if(r.admissionNo === st.admissionNo){
      if(r.status==="Present")P++;
      if(r.status==="Absent")A++;
      if(r.status==="Late")L++;
      if(r.status==="Leave")LV++;
      F += Number(r.fine||0);
    }
  });

  p.textContent=P;
  a.textContent=A;
  l.textContent=L;
  lv.textContent=LV;
  fine.textContent=F;
  status.textContent = F===0 ? "Cleared" : "Due";
}
</script>

</body>
</html>
