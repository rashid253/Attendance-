<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Login / Sign Up</title>

  <!-- Font Awesome for icons (optional) -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
  />

  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 400px;
      margin: 2em auto;
      padding: 1em;
      border: 1px solid #ccc;
      border-radius: 8px;
    }
    h2 {
      text-align: center;
    }
    form {
      display: flex;
      flex-direction: column;
      gap: 0.5em;
    }
    input, select, button {
      padding: 0.5em;
      font-size: 1rem;
      border: 1px solid #aaa;
      border-radius: 4px;
    }
    button {
      cursor: pointer;
      background-color: #2196F3;
      color: white;
      border: none;
    }
    .toggle-link {
      text-align: center;
      margin-top: 1em;
      color: #2196F3;
      cursor: pointer;
    }
    .error {
      color: red;
      margin-bottom: 0.5em;
    }
    .hidden {
      display: none;
    }
  </style>
</head>
<body>

  <h2 id="formTitle">Login</h2>

  <div id="errorMsg" class="error"></div>

  <!-- LOGIN FORM -->
  <form id="loginForm">
    <input type="email" id="loginEmail" placeholder="Email" required />
    <input type="password" id="loginPassword" placeholder="Password" required />
    <button type="submit">Login</button>
  </form>

  <!-- SIGN-UP FORM -->
  <form id="signupForm" class="hidden">
    <input type="text" id="signupName" placeholder="Full Name" required />
    <input type="email" id="signupEmail" placeholder="Email" required />
    <input type="password" id="signupPassword" placeholder="Password" required />
    <select id="signupRole" required>
      <option disabled selected>— Select Role —</option>
      <option value="admin">Admin</option>
      <option value="principal">Principal</option>
      <option value="teacher">Teacher</option>
    </select>
    <div id="principalFields" class="hidden">
      <input type="text" id="principalSchool" placeholder="Assigned School" />
    </div>
    <div id="teacherFields" class="hidden">
      <input type="text" id="teacherSchool" placeholder="Assigned School" />
      <select id="teacherClass">
        <option disabled selected>— Class —</option>
        <option>Play Group</option>
        <option>Nursery</option>
        <option>KG</option>
        <option>Class One</option>
        <option>Class Two</option>
        <option>Class Three</option>
        <option>Class Four</option>
        <option>Class Five</option>
        <option>Class Six</option>
        <option>Class Seven</option>
        <option>Class Eight</option>
        <option>Class Nine</option>
        <option>Class Ten</option>
      </select>
      <select id="teacherSection">
        <option disabled selected>— Section —</option>
        <option>A</option>
        <option>B</option>
        <option>C</option>
      </select>
    </div>
    <button type="submit">Sign Up</button>
  </form>

  <div class="toggle-link" id="toggleToSignup">Don’t have account? Sign up</div>
  <div class="toggle-link hidden" id="toggleToLogin">Already have account? Login</div>

  <!-- Firebase App (the core Firebase SDK) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <!-- Firebase Auth & Database -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <script type="module">
    //-------------------------------------
    // 1) FIREBASE INITIALIZATION
    //-------------------------------------
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import {
      getAuth,
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword,
      signOut,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
    import {
      getDatabase,
      ref,
      set,
      get,
      child
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBsx5pWhYGh1bJ9gL2bmC68gVc6EpICEzA",
      authDomain: "attandace-management.firebaseapp.com",
      databaseURL: "https://attandace-management-default-rtdb.firebaseio.com",
      projectId: "attandace-management",
      storageBucket: "attandace-management.appspot.com",
      messagingSenderId: "222685278846",
      appId: "1:222685278846:web:aa3e37a42b76befb6f5e2f",
      measurementId: "G-V2MY85R73B"
    };

    // Initialize Firebase (compat style for ease of use)
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const database = getDatabase(app);

    //-------------------------------------
    // 2) ELEMENT REFERENCES
    //-------------------------------------
    const loginForm        = document.getElementById("loginForm");
    const signupForm       = document.getElementById("signupForm");
    const toggleToSignup   = document.getElementById("toggleToSignup");
    const toggleToLogin    = document.getElementById("toggleToLogin");
    const formTitle        = document.getElementById("formTitle");
    const errorMsg         = document.getElementById("errorMsg");

    const loginEmail       = document.getElementById("loginEmail");
    const loginPassword    = document.getElementById("loginPassword");

    const signupName       = document.getElementById("signupName");
    const signupEmail      = document.getElementById("signupEmail");
    const signupPassword   = document.getElementById("signupPassword");
    const signupRole       = document.getElementById("signupRole");

    const principalFields  = document.getElementById("principalFields");
    const principalSchool  = document.getElementById("principalSchool");

    const teacherFields    = document.getElementById("teacherFields");
    const teacherSchool    = document.getElementById("teacherSchool");
    const teacherClassEl   = document.getElementById("teacherClass");
    const teacherSectionEl = document.getElementById("teacherSection");

    //-------------------------------------
    // 3) TOGGLE BETWEEN LOGIN / SIGNUP
    //-------------------------------------
    toggleToSignup.addEventListener("click", () => {
      errorMsg.textContent = "";
      formTitle.textContent = "Sign Up";
      loginForm.classList.add("hidden");
      signupForm.classList.remove("hidden");
      toggleToSignup.classList.add("hidden");
      toggleToLogin.classList.remove("hidden");
    });
    toggleToLogin.addEventListener("click", () => {
      errorMsg.textContent = "";
      formTitle.textContent = "Login";
      signupForm.classList.add("hidden");
      loginForm.classList.remove("hidden");
      toggleToLogin.classList.add("hidden");
      toggleToSignup.classList.remove("hidden");
      // hide role‐specific fields
      principalFields.classList.add("hidden");
      teacherFields.classList.add("hidden");
      signupRole.value = "";
    });

    //-------------------------------------
    // 4) SHOW/HIDE FIELDS BASED ON ROLE SELECTION
    //-------------------------------------
    signupRole.addEventListener("change", (e) => {
      const r = e.target.value;
      principalFields.classList.add("hidden");
      teacherFields.classList.add("hidden");

      if (r === "principal") {
        principalFields.classList.remove("hidden");
      } else if (r === "teacher") {
        teacherFields.classList.remove("hidden");
      }
    });

    //-------------------------------------
    // 5) SIGN-UP LOGIC
    //-------------------------------------
    signupForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      errorMsg.textContent = "";

      const name    = signupName.value.trim();
      const email   = signupEmail.value.trim();
      const pass    = signupPassword.value;
      const role    = signupRole.value;

      if (!name || !email || !pass || !role) {
        errorMsg.textContent = "All fields are required.";
        return;
      }
      if (role === "principal" && !principalSchool.value.trim()) {
        errorMsg.textContent = "Principal must specify assigned school.";
        return;
      }
      if (role === "teacher") {
        if (!teacherSchool.value.trim() || !teacherClassEl.value || !teacherSectionEl.value) {
          errorMsg.textContent = "Teacher must specify school, class, & section.";
          return;
        }
      }

      try {
        // 1) Create user in Firebase Auth
        const cred = await createUserWithEmailAndPassword(auth, email, pass);
        const uid = cred.user.uid;

        // 2) Write to /loginRequests/{uid} with status = "pending"
        const requestRef = ref(database, "loginRequests/" + uid);
        await set(requestRef, {
          email: email,
          name:  name,
          role:  role,
          school: (role === "principal" ? principalSchool.value.trim() : (role === "teacher" ? teacherSchool.value.trim() : "")),
          class:  (role === "teacher"   ? teacherClassEl.value : ""),
          section:(role === "teacher"   ? teacherSectionEl.value : ""),
          status: "pending",
          requestedAt: new Date().toISOString()
        });

        // 3) Immediately sign the user out (we don’t let them “in” until an admin approves)
        await signOut(auth);
        errorMsg.style.color = "green";
        errorMsg.textContent = "Sign-up request submitted. Awaiting admin approval.";
        signupForm.reset();
        principalFields.classList.add("hidden");
        teacherFields.classList.add("hidden");
        signupRole.value = "";
      } catch (err) {
        console.error(err);
        errorMsg.style.color = "red";
        errorMsg.textContent = "Error: " + err.message;
      }
    });

    //-------------------------------------
    // 6) LOGIN LOGIC
    //-------------------------------------
    loginForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      errorMsg.textContent = "";
      const email = loginEmail.value.trim();
      const pass  = loginPassword.value;

      if (!email || !pass) {
        errorMsg.textContent = "Email + password required.";
        return;
      }
      try {
        // 1) Sign in
        const cred = await signInWithEmailAndPassword(auth, email, pass);
        const uid = cred.user.uid;

        // 2) Look up /users/{uid}/status
        const userSnap = await get(child(ref(database), `users/${uid}`));
        if (!userSnap.exists()) {
          // no /users entry means still pending or not approved
          // check /loginRequests/{uid}/status
          const reqSnap = await get(child(ref(database), `loginRequests/${uid}`));
          if (reqSnap.exists()) {
            const r = reqSnap.val();
            if (r.status === "pending") {
              errorMsg.textContent = "Request still pending. Please wait.";
            } else if (r.status === "rejected") {
              errorMsg.textContent = "Your signup request was rejected by admin.";
            } else if (r.status === "blocked") {
              errorMsg.textContent = "Your account has been blocked. Contact admin.";
            } else {
              errorMsg.textContent = "Awaiting approval.";
            }
            // force sign out:
            await signOut(auth);
            return;
          } else {
            // user exists in Auth but no request found—block by default
            errorMsg.textContent = "No approval record found. Contact admin.";
            await signOut(auth);
            return;
          }
        }

        // 3) If /users/{uid} exists, check status
        const userData = userSnap.val();
        if (userData.status === "approved") {
          // redirect based on role:
          if (userData.role === "admin") {
            window.location.href = "admin.html";
          } else if (userData.role === "principal") {
            window.location.href = "principal.html";
          } else if (userData.role === "teacher") {
            window.location.href = "teacher.html";
          } else {
            errorMsg.textContent = "Unknown role. Contact admin.";
            await signOut(auth);
          }
        } else if (userData.status === "rejected") {
          errorMsg.textContent = "Your account was rejected. Contact admin.";
          await signOut(auth);
        } else if (userData.status === "blocked") {
          errorMsg.textContent = "Your account has been blocked. Contact admin.";
          await signOut(auth);
        } else {
          errorMsg.textContent = "Awaiting admin approval.";
          await signOut(auth);
        }
      } catch (err) {
        console.error(err);
        errorMsg.textContent = "Login error: " + err.message;
      }
    });

    //-------------------------------------
    // 7) AUTO-REDIRECT IF ALREADY LOGGED IN
    //-------------------------------------
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        // if they close the page and come back, redirect automatically
        const uid = user.uid;
        const userSnap = await get(child(ref(database), `users/${uid}`));
        if (userSnap.exists() && userSnap.val().status === "approved") {
          const r = userSnap.val().role;
          if (r === "admin") {
            window.location.href = "admin.html";
          } else if (r === "principal") {
            window.location.href = "principal.html";
          } else if (r === "teacher") {
            window.location.href = "teacher.html";
          } else {
            await signOut(auth);
          }
        } else {
          await signOut(auth);
        }
      }
    });
  </script>
</body>
</html>
