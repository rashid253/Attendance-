<!-- login.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Attendance Mgmt – Login</title>

  <!-- Firebase JS SDK (v9 modular) -->
  <script type="module">
    // IMPORTANT: Replace with your Firebase config
    const firebaseConfig = {
      apiKey: "<YOUR_FIREBASE_API_KEY>",
      authDomain: "<YOUR_FIREBASE_AUTH_DOMAIN>",
      projectId: "<YOUR_FIREBASE_PROJECT_ID>",
      storageBucket: "<YOUR_FIREBASE_STORAGE_BUCKET>",
      messagingSenderId: "<YOUR_FIREBASE_SENDER_ID>",
      appId: "<YOUR_FIREBASE_APP_ID>",
      measurementId: "<YOUR_FIREBASE_MEASUREMENT_ID>",
      databaseURL: "<YOUR_FIREBASE_DATABASE_URL>"
    };

    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import {
      getDatabase,
      ref as dbRef,
      set as dbSet,
      push as dbPush,
      get as dbGet,
      child as dbChild,
      query as dbQuery,
      orderByChild,
      equalTo
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";
    window.firebaseApp = initializeApp(firebaseConfig);
    window.database = getDatabase(window.firebaseApp);
  </script>

  <!-- idb-keyval (for storing currentUser) -->
  <script src="https://cdn.jsdelivr.net/npm/idb-keyval@3/dist/idb-keyval-iife.min.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 400px;
      margin: 40px auto;
      padding: 0 20px;
    }
    h1 {
      text-align: center;
      margin-bottom: 1rem;
    }
    .row {
      margin-bottom: 1rem;
    }
    label {
      display: block;
      margin-bottom: 0.5rem;
    }
    select, input[type="text"] {
      width: 100%;
      padding: 0.5rem;
      margin-bottom: 0.5rem;
    }
    button {
      width: 100%;
      padding: 0.7rem;
      background: #2196F3;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1rem;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .hidden {
      display: none;
    }
    .message {
      margin-top: 1rem;
      color: #d32f2f;
      text-align: center;
    }
  </style>
</head>
<body>
  <h1>Login / Request Access</h1>

  <div class="row">
    <label for="userType">I am a:</label>
    <select id="userType">
      <option value="" disabled selected>-- Select User Type --</option>
      <option value="Teacher">Teacher</option>
      <option value="Principal">Principal</option>
    </select>
  </div>

  <div class="row">
    <label for="fullName">Full Name (Identifier):</label>
    <input type="text" id="fullName" placeholder="e.g. John Doe" />
  </div>

  <div class="row">
    <label for="schoolSelect">Select School:</label>
    <select id="schoolSelect">
      <option value="" disabled selected>-- Select School --</option>
      <!-- Populated from Firebase → appData/schools -->
    </select>
  </div>

  <!-- Only show if “Teacher” is selected -->
  <div class="row hidden" id="classRow">
    <label for="classSelect">Select Class:</label>
    <select id="classSelect">
      <option value="" disabled selected>-- Select Class --</option>
      <!-- Populated from Firebase → appData/classesBySchool/<school> -->
    </select>
  </div>
  <div class="row hidden" id="sectionRow">
    <label for="sectionSelect">Select Section:</label>
    <select id="sectionSelect">
      <option value="" disabled selected>-- Select Section --</option>
      <!-- Populated from Firebase → appData/sectionsBySchool/<school>/<class> -->
    </select>
  </div>

  <button id="loginBtn">Log In / Request Access</button>

  <div class="message" id="messageBox"></div>

  <script type="module">
    import { get as idbGet, set as idbSet } from "https://cdn.jsdelivr.net/npm/idb-keyval@3/dist/idb-keyval-iife.min.js";

    const userTypeEl   = document.getElementById("userType");
    const fullNameEl   = document.getElementById("fullName");
    const schoolEl     = document.getElementById("schoolSelect");
    const classRow     = document.getElementById("classRow");
    const sectionRow   = document.getElementById("sectionRow");
    const classEl      = document.getElementById("classSelect");
    const sectionEl    = document.getElementById("sectionSelect");
    const loginBtn     = document.getElementById("loginBtn");
    const messageBox   = document.getElementById("messageBox");

    const db = window.database;
    const appDataRef = dbRef(db, "appData");

    // 1) Load existing schools into #schoolSelect
    async function loadSchools() {
      const snapshot = await dbGet(dbChild(appDataRef, "schools"));
      const list = snapshot.exists() ? snapshot.val() : [];
      schoolEl.innerHTML = `<option value="" disabled selected>-- Select School --</option>`
        + list.map(s => `<option value="${s}">${s}</option>`).join("");
    }

    // 2) Whenever school changes, if Teacher, load classes for that school
    schoolEl.onchange = async () => {
      if (userTypeEl.value === "Teacher") {
        const sch = schoolEl.value;
        // fetch classesBySchool/<sch>
        const snap = await dbGet(dbChild(appDataRef, `classesBySchool/${encodeKey(sch)}`));
        const clsList = snap.exists() ? snap.val() : [];
        classEl.innerHTML = `<option value="" disabled selected>-- Select Class --</option>`
          + clsList.map(c => `<option value="${c}">${c}</option>`).join("");
        classRow.classList.remove("hidden");
        sectionRow.classList.add("hidden");
        sectionEl.innerHTML = `<option value="" disabled selected>-- Select Section --</option>`;
      }
    };

    // 3) Whenever class changes, load sections for that school & class
    classEl.onchange = async () => {
      const sch = schoolEl.value;
      const cls = classEl.value;
      // fetch sectionsBySchool/<sch>/<cls>
      const snap = await dbGet(dbChild(appDataRef, `sectionsBySchool/${encodeKey(sch)}/${encodeKey(cls)}`));
      const secList = snap.exists() ? snap.val() : [];
      sectionEl.innerHTML = `<option value="" disabled selected>-- Select Section --</option>`
        + secList.map(s => `<option value="${s}">${s}</option>`).join("");
      sectionRow.classList.remove("hidden");
    };

    // 4) Show/hide class/section rows based on userType
    userTypeEl.onchange = () => {
      messageBox.textContent = "";
      if (userTypeEl.value === "Teacher") {
        classRow.classList.remove("hidden");
        sectionRow.classList.add("hidden");
        classEl.innerHTML = `<option value="" disabled selected>-- Select Class --</option>`;
        sectionEl.innerHTML = `<option value="" disabled selected>-- Select Section --</option>`;
      } else if (userTypeEl.value === "Principal") {
        classRow.classList.add("hidden");
        sectionRow.classList.add("hidden");
        classEl.innerHTML = `<option value="" disabled selected>-- Select Class --</option>`;
        sectionEl.innerHTML = `<option value="" disabled selected>-- Select Section --</option>`;
      }
    };

    // 5) Check if this user is already “approved” in Firebase
    //    If yes & status="active", let them in → store “currentUser” in IndexedDB and redirect to index.html.
    //    If yes & status="blocked", show error.
    //    If not found, create a “loginRequests” entry → show “Your request is pending…”
    loginBtn.onclick = async () => {
      messageBox.textContent = "";
      const fullName = fullNameEl.value.trim();
      const userType = userTypeEl.value;
      const sch      = schoolEl.value;
      const cls      = classEl.value;
      const sec      = sectionEl.value;

      if (!fullName || !userType || !sch || (userType==="Teacher" && (!cls || !sec))) {
        messageBox.textContent = "Please fill out all required fields.";
        return;
      }

      // 5.a) Look for an existing approvedUser with the same (fullName, userType, school, class, section)
      const approvedRef = dbRef(db, `approvedUsers`);
      // We can query by “fullName_userType_school_cls_sec” composite key.
      const compositeKey = encodeKey(`${fullName}||${userType}||${sch}||${userType==="Teacher"?cls:"ALL"}||${userType==="Teacher"?sec:"ALL"}`);

      //   “approvedUsers/<compositeKey> = { fullName, userType, school, class, section, status: "active" or "blocked" }”
      const snap = await dbGet(dbChild(approvedRef, compositeKey));
      if (snap.exists()) {
        const data = snap.val();
        if (data.status === "active") {
          // LOG THEM IN:
          await idbSet("currentUser", {
            fullName,
            userType,
            school: sch,
            class: (userType==="Teacher"? cls : "ALL"),
            section: (userType==="Teacher"? sec : "ALL")
          });
          // redirect to main app:
          window.location.href = "index.html";
          return;
        } else {
          // status=="blocked"
          messageBox.textContent = "Your account has been blocked. Contact the administrator.";
          return;
        }
      }

      // 5.b) Not found among approvedUsers → create a new request in “loginRequests”
      const loginReqRef = dbRef(db, `loginRequests`);
      const newReq = {
        fullName,
        userType,
        school: sch,
        class: (userType==="Teacher"? cls : "ALL"),
        section: (userType==="Teacher"? sec : "ALL"),
        timestamp: new Date().toISOString(),
        status: "pending"
      };
      await dbPush(loginReqRef, newReq);
      messageBox.textContent = "Your request has been submitted. Please wait for administrator approval.";
      loginBtn.disabled = true;
    };

    // When page loads, populate the school list
    window.addEventListener("DOMContentLoaded", loadSchools);

    // Utility: Firebase keys cannot contain “.” or “/” or “[ ]” etc. We replace “/” with “__”, etc.
    function encodeKey(str) {
      return str.replace(/\./g, "___")
                .replace(/\//g, "____")
                .replace(/\$/g, "_____")
                .replace(//g, "______")
                .replace(//g, "_______")
                .replace(/#/g, "________")
                .replace(/\\/g, "_________");
    }
  </script>
</body>
</html>
