<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Attendance Mgmt – Login</title>

  <!-- idb-keyval (IIFE) -->
  <script src="https://cdn.jsdelivr.net/npm/idb-keyval@3/dist/idb-keyval-iife.min.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 400px;
      margin: 40px auto;
      padding: 0 20px;
    }
    h1 {
      text-align: center;
      margin-bottom: 1rem;
    }
    .row {
      margin-bottom: 1rem;
    }
    label {
      display: block;
      margin-bottom: 0.5rem;
    }
    select, input[type="text"] {
      width: 100%;
      padding: 0.5rem;
      margin-bottom: 0.5rem;
    }
    button {
      width: 100%;
      padding: 0.7rem;
      background: #2196F3;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1rem;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .hidden {
      display: none;
    }
    .message {
      margin-top: 1rem;
      color: #d32f2f;
      text-align: center;
    }
  </style>
</head>
<body>
  <h1>Login / Request Access</h1>

  <div class="row">
    <label for="userType">I am a:</label>
    <select id="userType">
      <option value="" disabled selected>-- Select User Type --</option>
      <option value="Teacher">Teacher</option>
      <option value="Principal">Principal</option>
    </select>
  </div>

  <div class="row">
    <label for="fullName">Full Name (Identifier):</label>
    <input type="text" id="fullName" placeholder="e.g. John Doe" />
  </div>

  <div class="row">
    <label for="schoolSelect">Select School:</label>
    <select id="schoolSelect">
      <option value="" disabled selected>-- Select School --</option>
      <!-- Populated from Firebase via app.js -->
    </select>
  </div>

  <!-- Only show if “Teacher” is selected -->
  <div class="row hidden" id="classRow">
    <label for="classSelect">Select Class:</label>
    <select id="classSelect">
      <option value="" disabled selected>-- Select Class --</option>
      <!-- Populated from Firebase via app.js -->
    </select>
  </div>
  <div class="row hidden" id="sectionRow">
    <label for="sectionSelect">Select Section:</label>
    <select id="sectionSelect">
      <option value="" disabled selected>-- Select Section --</option>
      <!-- Populated from Firebase via app.js -->
    </select>
  </div>

  <button id="loginBtn">Log In / Request Access</button>

  <div class="message" id="messageBox"></div>

  <script type="module">
    // Import only what we need from app.js
    import { database, appDataRef, encodeKey } from "./app.js";
    import {
      ref as dbRef,
      get as dbGet,
      child as dbChild,
      push as dbPush
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";
    // idbKeyval is globally available (IIFE loaded above)
    const { get: idbGet, set: idbSet } = idbKeyval;

    const userTypeEl   = document.getElementById("userType");
    const fullNameEl   = document.getElementById("fullName");
    const schoolEl     = document.getElementById("schoolSelect");
    const classRow     = document.getElementById("classRow");
    const sectionRow   = document.getElementById("sectionRow");
    const classEl      = document.getElementById("classSelect");
    const sectionEl    = document.getElementById("sectionSelect");
    const loginBtn     = document.getElementById("loginBtn");
    const messageBox   = document.getElementById("messageBox");

    // 1) Load existing schools into #schoolSelect
    async function loadSchools() {
      const snap = await dbGet(child(appDataRef, "schools"));
      const list = snap.exists() ? snap.val() : [];
      schoolEl.innerHTML = `<option value="" disabled selected>-- Select School --</option>`
        + list.map(s => `<option value="${s}">${s}</option>`).join("");
    }

    // 2) Whenever school changes, if Teacher, load classes for that school
    schoolEl.onchange = async () => {
      messageBox.textContent = "";
      if (userTypeEl.value === "Teacher") {
        const sch = schoolEl.value;
        const snap = await dbGet(child(appDataRef, `classesBySchool/${encodeKey(sch)}`));
        const clsList = snap.exists() ? snap.val() : [];
        classEl.innerHTML = `<option value="" disabled selected>-- Select Class --</option>`
          + clsList.map(c => `<option value="${c}">${c}</option>`).join("");
        classRow.classList.remove("hidden");
        sectionRow.classList.add("hidden");
        sectionEl.innerHTML = `<option value="" disabled selected>-- Select Section --</option>`;
      }
    };

    // 3) Whenever class changes, load sections for that school & class
    classEl.onchange = async () => {
      const sch = schoolEl.value;
      const cls = classEl.value;
      const snap = await dbGet(child(appDataRef, `sectionsBySchool/${encodeKey(sch)}/${encodeKey(cls)}`));
      const secList = snap.exists() ? snap.val() : [];
      sectionEl.innerHTML = `<option value="" disabled selected>-- Select Section --</option>`
        + secList.map(s => `<option value="${s}">${s}</option>`).join("");
      sectionRow.classList.remove("hidden");
    };

    // 4) Show/hide class/section rows based on userType
    userTypeEl.onchange = () => {
      messageBox.textContent = "";
      if (userTypeEl.value === "Teacher") {
        classRow.classList.remove("hidden");
        sectionRow.classList.add("hidden");
        classEl.innerHTML = `<option value="" disabled selected>-- Select Class --</option>`;
        sectionEl.innerHTML = `<option value="" disabled selected>-- Select Section --</option>`;
      } else if (userTypeEl.value === "Principal") {
        classRow.classList.add("hidden");
        sectionRow.classList.add("hidden");
        classEl.innerHTML = `<option value="" disabled selected>-- Select Class --</option>`;
        sectionEl.innerHTML = `<option value="" disabled selected>-- Select Section --</option>`;
      }
    };

    // 5) Log In / Request Access logic
    loginBtn.onclick = async () => {
      messageBox.textContent = "";
      const fullName = fullNameEl.value.trim();
      const userType = userTypeEl.value;
      const sch      = schoolEl.value;
      const cls      = classEl.value;
      const sec      = sectionEl.value;

      if (!fullName || !userType || !sch || (userType==="Teacher" && (!cls || !sec))) {
        messageBox.textContent = "Please fill out all required fields.";
        return;
      }

      // Build the composite key
      const compositeKey = encodeKey(
        `${fullName}||${userType}||${sch}||${userType==="Teacher"?cls:"ALL"}||${userType==="Teacher"?sec:"ALL"}`
      );
      // Check approvedUsers/<compositeKey>
      const approvedSnap = await dbGet(child(dbRef(database), `approvedUsers/${compositeKey}`));
      if (approvedSnap.exists()) {
        const data = approvedSnap.val();
        if (data.status === "active") {
          // Already approved & active → log them in
          await idbSet("currentUser", {
            fullName,
            userType,
            school: sch,
            class: (userType==="Teacher"? cls : "ALL"),
            section: (userType==="Teacher"? sec : "ALL")
          });
          window.location.href = "index.html";
          return;
        } else {
          messageBox.textContent = "Your account has been blocked. Contact the administrator.";
          return;
        }
      }

      // Not approved → create a new loginRequests entry
      const loginReqRef = dbRef(database, "loginRequests");
      const newReq = {
        fullName,
        userType,
        school: sch,
        class: (userType==="Teacher"? cls : "ALL"),
        section: (userType==="Teacher"? sec : "ALL"),
        timestamp: new Date().toISOString(),
        status: "pending"
      };
      await dbPush(loginReqRef, newReq);
      messageBox.textContent = "Your request has been submitted. Please wait for administrator approval.";
      loginBtn.disabled = true;
    };

    // When page loads, populate the school list
    window.addEventListener("DOMContentLoaded", loadSchools);
  </script>
</body>
</html>
